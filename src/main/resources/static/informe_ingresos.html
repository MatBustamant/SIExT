<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Informe | Ingresos por Período</title>
  <link href="icons/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/tablas.css">
  <link rel="stylesheet" href="css/informes.css">
  <link rel="icon" href="images\icon.png">
</head>

<body>

  <h1>Informe de Ingresos</h1>
  <div class="informativo">Generado: <span id="fechaActual"></span></div>
  <div class="informativo">Período: <span id="periodoSeleccionado"></span></div>

  <button class="btn" onclick="window.print()"><i class="bi bi-printer"></i>Imprimir</button>
  <a href="informes.html" class="btn"><i class="bi bi-arrow-left"></i>Volver a Informes</a>

  <table id="tablaIngresos">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Cantidad Ingresada</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>SIExT | 2025</footer>

  <script>
    document.getElementById("fechaActual").textContent = new Date().toLocaleString();

    const params = new URLSearchParams(window.location.search);
    const desde = params.get("desde");
    const hasta = params.get("hasta");
    document.getElementById("periodoSeleccionado").textContent = `${desde} a ${hasta}`;

    const productos = JSON.parse(localStorage.getItem("productos")) || [];
    const ingresos = JSON.parse(localStorage.getItem("ingresos")) || [];

    const tbody = document.querySelector("#tablaIngresos tbody");

    // Preparar datos: filtrar, mapear, ordenar por fecha
    // const ingresosFiltrados = ingresos
    //   .filter(i => i.fecha >= desde && i.fecha <= hasta)
    //   .map(i => {
    //     const p = productos.find(prod => prod.id === i.productoId);
    //     return {
    //       fecha: i.fecha,
    //       clase: p ? p.clase : "Sin datos",
    //       nombre: p ? p.nombre : "Producto eliminado",
    //       categoria: p ? p.categoria : "-",
    //       cantidad: i.cantidad
    //     };
    //   })
    //   .sort((a, b) => a.fecha.localeCompare(b.fecha));
const ingresosFiltrados = Object.values(
  ingresos
    .filter(i => i.fecha >= desde && i.fecha <= hasta)
    .reduce((acc, i) => {
      const p = productos.find(prod => prod.id === i.productoId);
      const fecha = i.fecha;
      const nombre = p ? p.nombre : "Producto eliminado";
      const categoria = p ? p.categoria : "-";

      // clave única: fecha + nombre + categoría
      const clave = `${fecha}-${nombre}-${categoria}`;

      if (!acc[clave]) {
        acc[clave] = {
          fecha,
          clase: p ? p.clase : "Sin datos",
          nombre,
          categoria,
          cantidad: 0
        };
      }
      acc[clave].cantidad += 1;
      return acc;
    }, {})
).sort((a, b) => a.fecha.localeCompare(b.fecha));

    if (ingresosFiltrados.length === 0) {
      const fila = document.createElement("tr");
      fila.innerHTML = `<td colspan="4" style="text-align:center; padding:1rem;">No se registraron ingresos en ese período.</td>`;
      tbody.appendChild(fila);
    } else {
      // Agrupar por clase
      // const ingresosPorClase = {};
      // ingresosFiltrados.forEach(dato => {
      //   if (!ingresosPorClase[dato.clase]) ingresosPorClase[dato.clase] = [];
      //   ingresosPorClase[dato.clase].push(dato);
      // });

      // Insertar al DOM agrupado
      // Object.keys(ingresosPorClase).forEach(clase => {
      //   const filaClase = document.createElement("tr");
      //   filaClase.classList.add("grupo-clase");
      //   filaClase.innerHTML = `<td colspan="4">${clase}</td>`;
      //   tbody.appendChild(filaClase);

        ingresosFiltrados.forEach(dato => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${dato.fecha}</td>
            <td>${dato.nombre}</td>
            <td>${dato.categoria}</td>
            <td>${dato.cantidad}</td>
          `;
          tbody.appendChild(fila);
        });
      };
  </script>

</body>

</html>