<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Informe | Ingresos por Período</title>
  <link href="icons/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/tablas.css">
  <link rel="stylesheet" href="css/informes.css">
  <link rel="icon" href="images/icon.png">
</head>

<body>

  <h1>Informe de Ingresos</h1>
  <div class="informativo">Generado: <span id="fechaActual"></span></div>
  <div class="informativo">Período: <span id="periodoSeleccionado"></span></div>

  <button class="btn" onclick="window.print()"><i class="bi bi-printer"></i>Imprimir</button>
  <a href="informes.html" class="btn"><i class="bi bi-arrow-left"></i>Volver a Informes</a>

  <table id="tablaIngresos">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Cantidad Ingresada</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
  </table>

  <footer>SIExT | 2025</footer>

  <script>
    document.getElementById("fechaActual").textContent = new Date().toLocaleString();

    const params = new URLSearchParams(window.location.search);
    const desde = params.get("desde");
    const hasta = params.get("hasta");
    document.getElementById("periodoSeleccionado").textContent = `${desde} a ${hasta}`;

    const bienes = JSON.parse(localStorage.getItem("bienes")) || [];
    const eventos = JSON.parse(localStorage.getItem("eventos")) || [];

    const tbody = document.querySelector("#tablaIngresos tbody");

    const tfoot = document.querySelector("#tablaIngresos tfoot");

    const ingresosFiltrados = Object.values(
      eventos
        .filter(i => i.tipoEvento === "ENTREGA")
        .filter(i => i.fechaEvento >= desde && i.fechaEvento <= hasta)
        .reduce((acc, i) => {
          const p = bienes.find(prod => prod.id_Bien === i.bienAsociado);
          const fecha = i.fechaEvento.split("T")[0] + " " + i.fechaEvento.split("T")[1].replace("Z", "");
          const nombre = p ? p.nombre : "Producto eliminado";
          const categoria = p ? p.nombreCatBienes : "-";

      // clave única: fecha + nombre + categoría
      const clave = `${fecha}-${nombre}-${categoria}`;

      if (!acc[clave]) {
        acc[clave] = {
          fecha,
          clase: p ? p.clase : "Sin datos",
          nombre,
          categoria,
          cantidad: 0
        };
      }
      acc[clave].cantidad += 1;
      return acc;
    }, {})
).sort((a, b) => a.fecha.localeCompare(b.fecha));

    if (ingresosFiltrados.length === 0) {
      const fila = document.createElement("tr");
      fila.innerHTML = `<td colspan="4" style="text-align:center; padding:1rem;">No se registraron ingresos en ese período.</td>`;
      tbody.appendChild(fila);
    } else {

        ingresosFiltrados.forEach(dato => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${dato.fecha}</td>
            <td>${dato.nombre}</td>
            <td>${dato.categoria}</td>
            <td>${dato.cantidad}</td>
          `;
          tbody.appendChild(fila);
        });
      };

      // ---- Totales por categoría ----
      const totalesPorCategoria = ingresosFiltrados.reduce((acc, i) => {
        acc[i.categoria] = (acc[i.categoria] || 0) + i.cantidad;
        return acc;
      }, {});

      // ---- Total general ----
      const totalGeneral = ingresosFiltrados.reduce((sum, i) => sum + i.cantidad, 0);

      // Renderizar pie de tabla
      tfoot.innerHTML = "";
      Object.entries(totalesPorCategoria).forEach(([cat, total]) => {
        const filaCat = document.createElement("tr");
        filaCat.innerHTML = `
          <td colspan="3" style="text-align:right; font-weight:bold;">TOTAL ${cat}</td>
          <td style="font-weight:bold;">${total}</td>
        `;
        tfoot.appendChild(filaCat);
      });

      const filaTotal = document.createElement("tr");
      filaTotal.innerHTML = `
        <td colspan="3" style="text-align:right; font-weight:bold;">TOTAL GENERAL</td>
        <td style="font-weight:bold;">${totalGeneral}</td>
      `;
      tfoot.appendChild(filaTotal);
    
  </script>

</body>

</html>