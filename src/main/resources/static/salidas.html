<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrar salidas - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images\icon.png">
    <style>
        #listaProductosSeleccionados {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        #listaProductosSeleccionados>div {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        #listaProductosSeleccionados input[type="number"] {
            width: 60px;
        }
    </style>
</head>

<body>
    <header>SIExT | Registrar salidas</header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="inventario.html" class="btn"><i class="bi bi-card-list"></i></i>Listar Inventario</a></li>
                <li><a href="informes.html" class="btn"><i class="bi bi-file-earmark-text"></i>Generar Informes</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">

        <section>
            <h2>Registrar nueva salida</h2>
            <form id="movimientoForm">
                <label>N° Solicitud Asociada</label>
                <input type="number" id="numSolicitud" required min="1">
                <label>Legajo de quien retira</label>
                <input type="text" id="legajoRetira" required>
                <label>Destino</label>
                <input type="text" id="destino" required>
                <div class="form-grid">
                    <div>
                        <label>Fecha de salida</label>
                        <input type="date" id="fechaSalida" required>
                    </div>
                    <div>
                        <label>Hora de salida</label>
                        <input type="time" id="horaSalida" required>
                    </div>
                </div>
                <label>Agregar producto por ID</label>
                <div style="display: flex; gap: 0.5rem; margin-bottom:1rem;">
                    <input type="number" id="inputProductoId" placeholder="ID producto" />
                    <button type="button" id="btnAgregarProducto" class="btn">Agregar</button>
                </div>

                <div id="listaProductosSeleccionados"><small>No hay productos agregados.</small></div>

                <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
            </form>
        </section>

        <section>
            <h2>Salidas registradas</h2>
            <table id="tablaMovimientos">
                <thead>
                    <tr>
                        <th>Solicitud</th>
                        <th>Legajo</th>
                        <th>Destino</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Productos</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="informativo" id="contadorSalidas">Mostrando 3 salida(s). //ESTÁTICO</div>
        </section>

        <section id="modificarMovimientoSection" class="hidden">
            <h2>Editar salida</h2>
            <form id="modificarMovimientoForm">
                <input type="hidden" id="modMovimientoId" />
                <label>N° Solicitud Asociada</label>
                <input type="number" id="modNumSolicitud" required min="1" />
                <label>Legajo de quien retira</label>
                <input type="text" id="modLegajoRetira" required />
                <label>Destino</label>
                <input type="text" id="modDestino" required />
                <label>Fecha de salida</label>
                <input type="date" id="modFechaSalida" required />
                <label>Hora de salida</label>
                <input type="time" id="modHoraSalida" required />

                <label>Agregar producto por ID</label>
                <div style="display: flex; gap: 0.5rem; margin-bottom:1rem;">
                    <input type="number" id="modInputProductoId" placeholder="ID producto" />
                    <button type="button" id="modBtnAgregarProducto" class="btn">Agregar</button>
                </div>

                <div id="modListaProductosSeleccionados"><small>No hay productos agregados.</small></div>

                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="cancelarEdicionBtn"><i
                            class="bi bi-x-circle"></i>Cancelar</button>
                    <button type="button" class="btn btn-danger" id="eliminarMovimientoBtn"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>
    </main>

    <footer>SIExT | 2025</footer>

</body>

<script>
    let productos = JSON.parse(localStorage.getItem("productos")) || [];
    let productosSeleccionados = [];

    document.getElementById("btnAgregarProducto").addEventListener("click", () => {
        const idProd = parseInt(document.getElementById("inputProductoId").value);
        if (isNaN(idProd)) {
            alert("Ingresa un ID válido.");
            return;
        }

        const prod = productos.find(p => p.id === idProd);
        if (!prod) {
            alert("Producto no encontrado.");
            return;
        }

        // Verificar que no esté ya agregado
        if (productosSeleccionados.find(p => p.id === idProd)) {
            alert("Producto ya agregado.");
            return;
        }

        // Agregar a la lista de seleccionados
        productosSeleccionados.push(prod);

        // Renderizar producto en lista
        const cont = document.getElementById("listaProductosSeleccionados");
        const div = document.createElement("div");
        div.style = "display: flex; align-items: center; gap: 8px; margin-bottom: 8px;";

        // Ocultar mensaje de "No hay productos agregados"
        if (cont.querySelector("small")) {
            cont.innerHTML = "";
        }

        // Input texto con ID y nombre
        const inputTexto = document.createElement("input");
        inputTexto.type = "text";
        inputTexto.value = `ID: ${prod.id} - ${prod.nombre}`;
        inputTexto.disabled = true;
        inputTexto.style.flex = "1";

        // Input cantidad
        const inputCantidad = document.createElement("input");
        inputCantidad.type = "number";
        inputCantidad.min = "1";
        inputCantidad.value = "1";
        inputCantidad.style.width = "70px";

        if (prod.clase.startsWith("Bien")) {
            inputCantidad.disabled = true;
        } else {
            inputCantidad.max = prod.stock;

            // Valida que no se pase del stock
            inputCantidad.addEventListener("input", () => {
                let val = parseInt(inputCantidad.value);
                if (val > prod.stock) inputCantidad.value = prod.stock;
                if (val < 1 || isNaN(val)) inputCantidad.value = 1;
            });
        }

        // Botón eliminar
        const btnEliminar = document.createElement("button");
        btnEliminar.innerHTML = "<i class='bi bi-x-lg'></i>";
        btnEliminar.className = "btn btn-danger";
        btnEliminar.style.height = "36px";
        btnEliminar.style.marginBottom = "1rem";
        btnEliminar.type = "button";
        btnEliminar.addEventListener("click", () => {
            // Quitar de productosSeleccionados
            productosSeleccionados = productosSeleccionados.filter(p => p.id !== prod.id);
            div.remove();
            if (productosSeleccionados.length === 0) {
                cont.innerHTML = "<small>No hay productos agregados.</small>";
            }
        });

        // Guardar el input cantidad como propiedad extra para poder leerlo al guardar
        prod.inputCantidad = inputCantidad;


        // Agregar al contenedor
        div.appendChild(inputTexto);
        div.appendChild(inputCantidad);
        div.appendChild(btnEliminar);

        cont.appendChild(div);

        // Limpiar input ID
        document.getElementById("inputProductoId").value = "";
    });
</script>

<script>
    // Guardar salida completa
    document.getElementById("movimientoForm").addEventListener("submit", e => {
        e.preventDefault();

        if (productosSeleccionados.length === 0) {
            alert("Agregá al menos un producto.");
            return;
        }

        const solicitud = document.getElementById("numSolicitud").value.trim();
        const legajo = document.getElementById("legajoRetira").value.trim();
        const destino = document.getElementById("destino").value.trim();
        const fecha = document.getElementById("fechaSalida").value;
        const hora = document.getElementById("horaSalida").value;

        if (!solicitud || !legajo || !destino || !fecha || !hora) {
            alert("Completá todos los campos.");
            return;
        }

        // Cargar productos actualizados desde localStorage
        let productosActuales = JSON.parse(localStorage.getItem("productos")) || [];

        // Armar listado de productos para guardar y actualizar productos existentes
        const productosParaGuardar = productosSeleccionados.map(p => {
            const cantidad = p.clase.startsWith("Bien") ? 1 : parseInt(p.inputCantidad.value);

            // Buscar producto original
            const prodIndex = productosActuales.findIndex(prod => prod.id === p.id);
            if (prodIndex >= 0) {
                if (p.clase.startsWith("Bien")) {
                    // Actualizar ubicación
                    productosActuales[prodIndex].ubicacion = destino;
                } else {
                    // Descontar stock
                    productosActuales[prodIndex].stock -= cantidad;
                    if (productosActuales[prodIndex].stock < 0) productosActuales[prodIndex].stock = 0;
                }
            }

            return {
                id: p.id,
                nombre: p.nombre,
                clase: p.clase,
                cantidad: cantidad
            };
        });

        // Guardar productos actualizados en localStorage
        localStorage.setItem("productos", JSON.stringify(productosActuales));

        // Guardar movimiento
        const nuevoMovimiento = {
            id: Date.now(),
            solicitud: solicitud,
            legajo: legajo,
            destino: destino,
            fecha: fecha,
            hora: hora,
            productos: productosParaGuardar
        };

        let movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];
        movimientos.push(nuevoMovimiento);
        localStorage.setItem("movimientos", JSON.stringify(movimientos));

        alert("Salida registrada y productos actualizados.");

        // Limpiar formulario y listado
        e.target.reset();
        document.getElementById("listaProductosSeleccionados").innerHTML = "<small>No hay productos agregados.</small>";
        productosSeleccionados = [];
        cargarMovimientos();
    });
</script>

<script>
    function cargarMovimientos() {
        const movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];
        const tablaMovimientosBody = document.getElementById("tablaMovimientos").querySelector("tbody");
        tablaMovimientosBody.innerHTML = ""; // Limpiar tabla antes de cargar

        movimientos.forEach(mov => {
            const fila = document.createElement("tr");

            // Procesar productos: resumir bienes iguales
            const insumos = [];
            const bienesContados = {};

            mov.productos.forEach(p => {
                if (p.clase.startsWith("Bien")) {
                    if (!bienesContados[p.nombre]) {
                        bienesContados[p.nombre] = 1;
                    } else {
                        bienesContados[p.nombre]++;
                    }
                } else {
                    insumos.push(`${p.cantidad} × ${p.nombre}`);
                }
            });

            // Armar texto de productos
            let textoProductos = "";

            const bienesListado = Object.entries(bienesContados).map(([nombre, cantidad]) => {
                return `${cantidad} × ${nombre}`;
            });

            const listaTotal = [...insumos, ...bienesListado];
            textoProductos = listaTotal.join("</p><p>");

            // Construir fila
            fila.innerHTML = `
            <td>${mov.solicitud}</td>
            <td>${mov.legajo}</td>
            <td>${mov.destino}</td>
            <td>${mov.fecha}</td>
            <td>${mov.hora}</td>
            <td><p>${textoProductos}</p></td>
            <td>
                <button class="btn btn-editar" data-id="${mov.id}"><i class="bi bi-pencil"></i></button>
            </td>
        `;

            tablaMovimientosBody.appendChild(fila);
        });
    }
    cargarMovimientos();
</script>

<script>
    // Cargar movimiento en formulario de edición
    document.addEventListener("click", e => {
        if (e.target.closest(".btn-editar")) {
            const idMov = parseInt(e.target.closest(".btn-editar").dataset.id);
            const movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];
            const mov = movimientos.find(m => m.id === idMov);
            if (!mov) {
                alert("Movimiento no encontrado.");
                return;
            }

            // Mostrar sección de edición y ocultar alta
            document.getElementById("modificarMovimientoSection").classList.remove("hidden");
            document.getElementById("movimientoForm").parentElement.classList.add("hidden");

            // Completar campos
            document.getElementById("modMovimientoId").value = mov.id;
            document.getElementById("modNumSolicitud").value = mov.solicitud;
            document.getElementById("modLegajoRetira").value = mov.legajo;
            document.getElementById("modDestino").value = mov.destino;
            document.getElementById("modFechaSalida").value = mov.fecha;
            document.getElementById("modHoraSalida").value = mov.hora;

            // Limpiar y cargar productos seleccionados
            const cont = document.getElementById("modListaProductosSeleccionados");
            cont.innerHTML = "";
            if (mov.productos.length === 0) {
                cont.innerHTML = "<small>No hay productos agregados.</small>";
            } else {
                cont.innerHTML = ""; // Limpiar mensaje
            }

            mov.productos.forEach(p => {
                const div = document.createElement("div");
                div.style = "display: flex; align-items: center; gap: 8px; margin-bottom: 8px;";

                const inputTexto = document.createElement("input");
                inputTexto.type = "text";
                inputTexto.value = `ID: ${p.id} - ${p.nombre}`;
                inputTexto.disabled = true;
                inputTexto.style.flex = "1";

                const inputCantidad = document.createElement("input");
                inputCantidad.type = "number";
                inputCantidad.min = "1";
                inputCantidad.value = p.cantidad;
                inputCantidad.style.width = "70px";

                if (p.clase.startsWith("Bien")) {
                    inputCantidad.disabled = true;
                }

                // Botón eliminar
                const btnEliminar = document.createElement("button");
                btnEliminar.innerHTML = "<i class='bi bi-x-lg'></i>";
                btnEliminar.className = "btn btn-danger";
                btnEliminar.style.height = "36px";
                btnEliminar.style.marginBottom = "1rem";
                btnEliminar.type = "button";
                btnEliminar.addEventListener("click", () => div.remove());

                div.appendChild(inputTexto);
                div.appendChild(inputCantidad);
                div.appendChild(btnEliminar);

                cont.appendChild(div);
            });
        }
    });
    // Botón cancelar edición
    document.getElementById("cancelarEdicionBtn").addEventListener("click", () => {
        if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
            document.getElementById("modificarMovimientoForm").reset();
            document.getElementById("modListaProductosSeleccionados").innerHTML = "<small>No hay productos agregados.</small>";
            document.getElementById("modificarMovimientoSection").classList.add("hidden");
            document.getElementById("movimientoForm").parentElement.classList.remove("hidden");
        }
    });
</script>

</html>