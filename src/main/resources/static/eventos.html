<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrar eventos - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images/icon.png">
</head>

<body>

    <header>
        <span>SIExT | Registrar eventos</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="bienes.html" class="btn"><i class="bi bi-box-seam"></i>Gestionar Bienes</a></li>
                <li id="supervisor-only-accion" class="hidden"><a href="informes.html" class="btn"><i class="bi bi-file-earmark-text"></i>Generar Informes</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">
        <!-- Formulario para agregar nuevo evento -->
        <section>
            <h2>Registrar evento sobre un bien</h2>
            <form id="registroEventoForm">
                <div class="form-grid">
                    <div>
                        <label>Nro. de inventario</label>
                        <input id="bienAsociado" type="number" required>
                    </div>
                    <div>
                        <label>Tipo de evento</label>
                        <select id="tipoEvento" required>
                            <option value="">Seleccionar</option>
                            <option value="AVERIO">Averío</option>
                            <option value="REPARACION">Reparación</option>
                            <option value="ENTREGA">Entrega</option>
                        </select>
                    </div>
                </div>

                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
                </div>
            </form>
        </section>

        <!-- Gestión de eventos -->
        <section>
            <h2>Eventos registrados</h2>
            <!-- Filtros -->
            <div class="form-grid">
                <div>
                    <input id="filterBienInput" type="number" placeholder="Filtrar por nro. de inventario">
                </div>
                <div>
                    <select id="filterTipoEvento">
                        <option value="">Todos los eventos</option>
                        <option value="AVERIO">Averío</option>
                        <option value="REPARACION">Reparación</option>
                        <option value="ENTREGA">Entrega</option>
                    </select>
                </div>
                <div>
                    <input type="date" id="filterFecha">
                </div>
            </div>

            <table id="tablaEventos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Bien</th>
                        <th>Tipo</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="informativo" id="counterEventos"></div>
        </section>

        <!-- Formulario para modificar evento seleccionado -->
        <section id="modificarEventoSection" class="hidden">
            <h2>Actualizar evento</h2>
            <form id="modificarEventoForm">
                <label>Identificador de evento</label>
                <input type="number" id="modEventoId" disabled>

                <label>Nro. de inventario</label>
                <div class="input-prefix">
                    <span>FCE-</span>
                    <input type="number" id="modBienId" required>
                </div>

                <label>Tipo de evento</label>
                <select id="modTipoEvento" required>
                    <option value="">Seleccionar</option>
                    <option value="AVERIO">Averío</option>
                    <option value="REPARACION">Reparación</option>
                    <option value="ENTREGA">Entrega</option>
                </select>

                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="cancelarEdicionBtn"><i
                            class="bi bi-x-circle"></i>Cancelar</button>
                    <button type="button" class="btn btn-danger" id="eliminarEventoBtn"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>

    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
        mostrarSegunRol("SUPERVISOR");
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/formateo.js"></script>
    <script src="js/fechas.js"></script>
    <script src="js/forms.js"></script>
    <script>
        recargarEventos();
        recargarBienes();
        function renderEventos() {
            const eventos = JSON.parse(localStorage.getItem("eventos")) || [];
            const eventosHabilitados = eventos.filter(e => !e.eliminado);

            const bienes = JSON.parse(localStorage.getItem("bienes")) || [];

            const filterBienInput = document.getElementById("filterBienInput").value;
            const filterTipoEvento = document.getElementById("filterTipoEvento").value;
            const filterFecha = document.getElementById("filterFecha").value;

            const tbody = document.querySelector("#tablaEventos tbody");
            tbody.innerHTML = "";

            let count = 0;

            eventosHabilitados.forEach(evento => {
                if (matchNumero(formatearNroBien(evento.bienAsociado), filterBienInput) &&
                    matchValor(evento.tipoEvento, filterTipoEvento) &&
                    matchFecha(evento.fechaEvento, filterFecha)
                ) {
                    const bien = bienes.find(b => b.id_Bien === evento.bienAsociado);
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${evento.id_Evento}</td>
                        <td>#${formatearNroBien(evento.bienAsociado)} — ${bien.nombre}</td>
                        <td>${evento.tipoEvento}</td>
                        <td>${formatearFechaHora(evento.fechaEvento)}</td>
                        <td>
                            <button class="btn btn-editar" data-id="${evento.id_Evento}" title="Editar evento">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    count++;
                }
            });

            document.getElementById("counterEventos").textContent = `Mostrando ${count} evento(s).`;
        }

        document.querySelector("#tablaEventos tbody").addEventListener("click", (e) => {
            // Buscamos si el clic fue en un botón de editar
            const btnEditar = e.target.closest(".btn-editar");
            if (btnEditar) {
                const id = Number(btnEditar.dataset.id);
                editarEvento(id);
                return;
            }

            // Buscamos si el clic fue en un botón de toggle detalles
            // const btnToggle = e.target.closest(".btn-toggle");
            // if (btnToggle) {
            //     toggleDetalles(btnToggle);
            //     return;
            // }
        });

        // Filtros
        document.querySelectorAll("#filterBienInput, #filterTipoEvento, #filterFecha")
            .forEach(input => {
                const eventType = (input.tagName === "SELECT" || input.type === "date") ? "change" : "input";
                input.addEventListener(eventType, () => {
                    // currentPage = 1;
                    renderEventos();
                });
        });

        renderEventos();

        document.getElementById("registroEventoForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const tipoEvento = document.getElementById("tipoEvento").value.toUpperCase();
            const bienAsociado = document.getElementById("bienAsociado").value;
            if (!tipoEvento || !bienAsociado) {
                alert("Datos incompletos.");
                return;
            }

            const evento = {
                tipoEvento,
                bienAsociado
            }

            try {
                const response = await crearEvento(evento);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 404) {
                        alert("Bien no encontrado.");
                        return;
                    }
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar el registro del evento. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Evento registrado.");
            await recargarEventos();
            await recargarBienes();

            renderEventos();
            e.target.reset();
        });

        function editarEvento(id) {
            const eventos = JSON.parse(localStorage.getItem("eventos")) || [];
            const evento = eventos.find(e => e.id_Evento === id);
            if (!evento) return;
            document.getElementById("modEventoId").value = evento.id_Evento;
            document.getElementById("modBienId").value = evento.bienAsociado;
            document.getElementById("modTipoEvento").value = evento.tipoEvento;

            document.getElementById("modificarEventoSection").classList.remove("hidden");

            document.getElementById("modBienId").focus();
        }

        document.getElementById("modificarEventoForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = +document.getElementById("modEventoId").value;

            const eventoModificado = {
                tipoEvento: document.getElementById("modTipoEvento").value.trim().toUpperCase(),
                bienAsociado: document.getElementById("modBienId").value
            }

            try {
                const response = await modificarEvento(eventoModificado, id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 404) {
                        alert("Evento no encontrado.");
                        return;
                    }
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la modificación del evento. Código: 500");
                        return;
                    } else {
                        alert(`El servidor no pudo realizar la modificación del evento. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            alert("Evento actualizado.");
            await recargarEventos();
            await recargarBienes();

            renderEventos();
            document.getElementById("modificarEventoSection").classList.add("hidden");
            e.target.reset();

            document.getElementById("tablaEventos").parentElement.scrollIntoView({ behavior: "smooth" });
        });

        // Cancelar edición de datos
        document.getElementById("cancelarEdicionBtn").onclick = () => {
            if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                document.getElementById("modificarEventoSection").classList.add("hidden");
                document.getElementById("modificarEventoForm").reset();

                document.getElementById("tablaEventos").parentElement.scrollIntoView({ behavior: "smooth" });
            }
        };

        document.getElementById("eliminarEventoBtn").addEventListener("click", async () => {
            const id = +document.getElementById("modEventoId").value;
            if (!confirm("¿Eliminar este evento?")) return;

            try {
                const response = await eliminarEvento(id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la eliminación del evento. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la eliminación del evento. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Evento eliminado.");
            await recargarEventos();
            await recargarBienes();
            renderEventos();
            document.getElementById("modificarEventoSection").classList.add("hidden");
            document.getElementById("modificarEventoForm").reset();

            document.getElementById("tablaEventos").parentElement.scrollIntoView({ behavior: "smooth" });
        });
    </script>

</body>

</html>