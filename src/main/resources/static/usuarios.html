<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestionar usuarios - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images\icon.png">
</head>

<body>

    <header>
        <span>
            SIExT | Gestionar usuarios
        </span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">

        <!-- Formulario para registrar nuevo usuario -->
        <section>
            <h2>Registrar nuevo usuario</h2>
            <form id="formNuevoUsuario">
                <label>Nombre de usuario</label>
                <input type="text" id="nuevoUsuario" required>

                <label>Contraseña</label>
                <input type="password" id="nuevoPassword" required>

                <label>Rol</label>
                <select id="nuevoRol" required>
                    <option value="">Seleccionar</option>
                    <option value="ADMINISTRATIVO">Administrativo</option>
                    <option value="SUPERVISOR">Supervisor</option>
                </select>

                <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
            </form>
        </section>

        <!-- Gestión de usuarios registrados -->
        <section>
            <h2>Usuarios registrados</h2>
            <!-- Filtros -->
            <div class="form-grid">
                <div>
                    <input type="text" id="filterUsuario" placeholder="Filtrar por nombre o ID...">
                </div>
                <div>
                    <select id="filterRol">
                        <option value="">Todos los roles</option>
                        <option value="ADMINISTRATIVO">Administrativo</option>
                        <option value="SUPERVISOR">Supervisor</option>
                    </select>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios">
                </tbody>
            </table>

            <div class="informativo" id="counterUsuarios"></div>
        </section>

        <!-- Formulario para modificar usuario seleccionado -->
        <section id="modificarUsuarioSection" class="hidden">
            <h2>Modificar usuario</h2>
            <form id="formModificarUsuario">
                <input type="hidden" id="modUsuarioId">

                <label>Nombre de usuario</label>
                <input type="text" id="modNombreUsuario" required>

                <label>Contraseña</label>
                <input type="password" id="modPasswordUsuario" required>

                <label>Rol</label>
                <select id="modRolUsuario" required>
                    <option value="">Seleccionar</option>
                    <option value="ADMINISTRATIVO">Administrativo</option>
                    <option value="SUPERVISOR">Supervisor</option>
                </select>

                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="btnCancelarEdicion"><i
                            class="bi bi-x-circle"></i>Cancelar</button>

                    <button type="button" class="btn btn-danger" id="btnEliminarUsuario"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>
    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth("SUPERVISOR");
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        recargarUsuarios();
        function renderUsuarios() {
            const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
            const usuariosHabilitados = usuarios.filter(u => !u.eliminado);

            const filtroUsuario = document.getElementById("filterUsuario").value.toUpperCase();
            const filtroRol = document.getElementById("filterRol").value.toUpperCase();

            const tabla = document.getElementById("tablaUsuarios");
            tabla.innerHTML = "";
            let count = 0;

            usuariosHabilitados.forEach(usuario => {
                const matchUsuario = txt => usuario.nombre.toUpperCase().includes(txt) || String(usuario.id_Usuario).includes(txt);
                const matchRol = (rol, filtro) => !filtro || rol === filtro;

                if (matchUsuario(filtroUsuario) && matchRol(usuario.rol, filtroRol)
                ) {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                    <td>${usuario.id_Usuario}</td>
                    <td>${usuario.nombre}</td>
                    <td>${usuario.rol}</td>
                    <td>
                        <button class="btn" onclick='editarUsuario(${usuario.id_Usuario})'><i class="bi bi-pencil"></i></button>
                    </td>
                    `;
                    tabla.appendChild(fila);
                    count++;
                }
            });

            document.getElementById("counterUsuarios").textContent = `Mostrando ${count} usuario(s).`;
        }
        document.getElementById("filterUsuario").addEventListener("input", renderUsuarios);
        document.getElementById("filterRol").addEventListener("change", renderUsuarios);
        renderUsuarios();

        document.getElementById("formNuevoUsuario").addEventListener("submit", async (e) => {
            e.preventDefault();

            const nombre = document.getElementById("nuevoUsuario").value.trim().toUpperCase();
            const contraseña = document.getElementById("nuevoPassword").value.trim();
            const rol = document.getElementById("nuevoRol").value.toUpperCase();
            if (!nombre || !contraseña || !rol) {
                alert("Datos incompletos.");
                return;
            }

            const usuario = {
                nombre,
                contraseña,
                rol
            }

            try {
                const response = await crearUsuario(usuario);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    else {
                    alert(`El servidor no pudo realizar el registro del usuario. Código: ${response.status}`);
                    return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Usuario registrado.");
            await recargarUsuarios();

            renderUsuarios();
            e.target.reset();
        });

        function editarUsuario(id) {
            const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
            const usuario = usuarios.find(u => u.id_Usuario === id);
            if (!usuario) return;

            document.getElementById("modUsuarioId").value = usuario.id_Usuario;
            document.getElementById("modNombreUsuario").value = usuario.nombre;
            document.getElementById("modPasswordUsuario").value = "";
            document.getElementById("modRolUsuario").value = usuario.rol;

            document.getElementById("modificarUsuarioSection").classList.remove("hidden");
        }

        document.getElementById("formModificarUsuario").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = +document.getElementById("modUsuarioId").value;
            let usuario;
            try {
                const response = await leerUsuario(id);
                if (!response.ok) {
                    document.getElementById("modificarUsuarioSection").classList.add("hidden");
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 404) {
                        alert("Usuario no encontrado.");
                        return;
                    }
                    else if (response.status == 500) {
                        alert("El servidor no pudo realizar la búsqueda del usuario. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la búsqueda del usuario. Código: ${response.status}`);
                        return;
                    }
                }
                usuario = await response.json();
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            const usuarioModificado = {
                nombre: document.getElementById("modNombreUsuario").value.toUpperCase(),
                contraseña: document.getElementById("modPasswordUsuario").value,
                rol: document.getElementById("modRolUsuario").value.toUpperCase()
            }

            try {
                const response = await modificarUsuario(usuarioModificado, id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la modificación del usuario. Código: 500");
                        return;
                    } else {
                    alert(`El servidor no pudo realizar la modificación del usuario. Código: ${response.status}`);
                    return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            alert("Usuario actualizado.");
            await recargarUsuarios();

            renderUsuarios();
            document.getElementById("modificarUsuarioSection").classList.add("hidden");
            e.target.reset();
        });

        // Cancelar edición de datos
        document.getElementById("btnCancelarEdicion").onclick = () => {
            if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                document.getElementById("modificarUsuarioSection").classList.add("hidden");
                document.getElementById("modificarUsuarioSection").reset();
            }
        };

        document.getElementById("btnEliminarUsuario").addEventListener("click", async () => {
            const id = +document.getElementById("modUsuarioId").value;
            if (!confirm("¿Eliminar este usuario?")) return;

            try {
                const response = await eliminarUsuario(id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la eliminación del usuario. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la eliminación del usuario. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Usuario eliminado.");
            await recargarUsuarios();
            renderUsuarios();
            document.getElementById("modificarUsuarioSection").classList.add("hidden");
            document.getElementById("modificarUsuarioSection").reset();
        });
    </script>
</body>

</html>