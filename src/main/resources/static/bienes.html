<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestionar bienes - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images\icon.png">
    <style>
        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
        }

        .badge.disponible {
            background-color: var(--verde);
        }

        .badge.averiado {
            background-color: var(--rojo);
        }

        .badge.reservado {
            background-color: var(--amarillo);
            color: var(--negro);
        }
    </style>
</head>

<body>
    <header>
        <span>SIExT | Gestionar bienes</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="categorias.html" class="btn"><i class="bi bi-tags"></i>Editar Categorías</a></li>
                <li><a href="ubicaciones.html" class="btn"><i class="bi bi-geo-alt"></i>Editar Ubicaciones</a></li>
                <li><a href="eventos.html" class="btn"><i class="bi bi-exclamation-circle"></i>Registrar Eventos</a>
                </li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">
        <!-- Formulario registrar producto nuevo -->
        <section>
            <h2>Registrar nuevo bien</h2>
            <form id="productoForm">
                <div class="form-grid">
                    <div>
                        <label>Categoría</label>
                        <input list="categoriasSugeridas" type="text" id="categoriaProducto" required>
                        <datalist id="categoriasSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Nombre</label>
                        <input type="text" id="nombreProducto" required>
                    </div>
                    <div>
                        <label>Ubicación</label>
                        <input list="ubicacionesSugeridas" type="text" id="ubicacionProducto" required>
                        <datalist id="ubicacionesSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Cantidad</label>
                        <input type="number" id="stockInicial" min="1" value="1" required>
                    </div>
                </div>
                <div>
                    <label>Detalle</label>
                    <input type="text" id="detalleProducto" placeholder="Detalles extras opcionales...">
                </div>
                <div>
                    <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
                </div>
            </form>
        </section>

        <!-- Gestión de bienes -->
        <section>
            <h2>Bienes registrados</h2>
            <!-- Filtros -->
            <div class="form-grid">
                <div>
                    <input type="text" id="filterBienInput" placeholder="Filtrar por nombre o nro. de inventario...">
                </div>
                <div>
                    <input list="categoriasSugeridas" type="text" id="filterBienCategoria" placeholder="Filtrar por ubicación..."></input>
                </div>
                <div>
                    <select id="filterBienEstado">
                        <option value="">Todos los estados</option>
                        <option value="EN_CONDICIONES">EN CONDICIONES</option>
                        <option value="AVERIADO">AVERIADO</option>
                    </select>
                </div>
                <div>
                    <input list="ubicacionesSugeridas" type="text" id="filterBienUbicacion" placeholder="Filtrar por ubicación..."></select>
                </div>
            </div>

            <table id="bienesTable">
                <thead>
                    <tr>
                        <th>Nro. de inv.</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Estado</th>
                        <th>Ubicación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody></tbody>
            </table>

            <div class="informativo" id="counterBienes"></div>
        </section>

        <!-- Formulario para modificar bien seleccionado -->
        <section id="modificarBienSection" class="hidden">
            <h2>Actualizar bien</h2>
            <form id="modificarBienForm">
                <input type="hidden" id="modBienId">
                <div>
                    <label>Categoría</label>
                    <input list="categoriasSugeridas" type="text" id="modCategoria" required>
                </div>
                <div>
                    <label>Nombre</label>
                    <input type="text" id="modNombre" required>
                </div>
                <div>
                    <label>Ubicación</label>
                    <input list="ubicacionesSugeridas" type="text" id="modUbicacion" required>
                </div>
                <div>
                    <label>Detalle</label>
                    <input type="text" id="modDetalleProducto" placeholder="Detalles extras opcionales...">
                </div>
                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="cancelarBtn"><i class="bi bi-x-circle"></i>Cancelar</button>
                    <button type="button" class="btn btn-danger" id="eliminarBienBtn"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>

    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/formateo.js"></script>
    <script>
        const categoriaProducto = document.getElementById("categoriaProducto");
        const ubicacionProducto = document.getElementById("ubicacionProducto");
        const modBienId = document.getElementById("modBienId");
        const modNombre = document.getElementById("modNombre");
        const modCategoria = document.getElementById("modCategoria");
        const modUbicacion = document.getElementById("modUbicacion");
        const modDetalleProducto = document.getElementById("modDetalleProducto");
        const modificarForm = document.getElementById("modificarBienForm");

        function renderInventario() {
            const bienes = JSON.parse(localStorage.getItem("bienes")) || [];
            const categorias = JSON.parse(localStorage.getItem("categorias")) || [];

            const bienFiltroTexto = document.getElementById("filterBienInput").value.toUpperCase();
            const bienFiltroCategoria = document.getElementById("filterBienCategoria").value.toUpperCase().trim();
            const bienFiltroEstado = document.getElementById("filterBienEstado").value;
            const bienFiltroUbicacion = document.getElementById("filterBienUbicacion").value.toUpperCase().trim();

            const bienesTable = document.getElementById("bienesTable").querySelector("tbody");
            bienesTable.innerHTML = "";

            let countBienes = 0;

            bienes.forEach(prod => {
                const matchTexto = txt => prod.nombre.toUpperCase().includes(txt) || String(formatearNroBien(prod.id_Bien)).includes(txt);
                const matchCategoria = (cat, filtro) => !filtro || cat.toUpperCase().includes(filtro);
                const matchEstado = (estado, filtro) => !filtro || estado === filtro;
                const matchUbicacion = (ubicacion, filtro) => !filtro || ubicacion.toUpperCase().includes(filtro);

                if (matchTexto(bienFiltroTexto) && matchCategoria(prod.nombreCatBienes, bienFiltroCategoria)
                    && matchEstado(prod.estadoBien, bienFiltroEstado)
                    && matchUbicacion(prod.ubicacionBien, bienFiltroUbicacion)
                ) {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${formatearNroBien(prod.id_Bien)}</td>
                    <td>${prod.nombre}</td>
                    <td>${prod.nombreCatBienes}</td>
                    <td><span class="badge ${prod.estadoBien === "EN_CONDICIONES" ? 'disponible' : 'averiado'}">${(prod.estadoBien).replace("_", " ")}</span></td>
                    <td>${prod.ubicacionBien}</td>
                    <td>
                        <button class='btn' onclick='editarBien(${prod.id_Bien})'><i class='bi bi-pencil'></i></button>
                    </td>`;
                    bienesTable.appendChild(row);
                    countBienes++;
                }
            });

            document.getElementById("counterBienes").textContent = `Mostrando ${countBienes} bien(es).`;
        }

        function cargarCategorias(idSelect) {
            const sel = document.getElementById(idSelect);
            sel.innerHTML = "";
            const cats = JSON.parse(localStorage.getItem("categorias")) || [];
            if (idSelect == "filterBienCategoria") {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Todas las categorías";
                sel.appendChild(opt);
            }
            if (cats.length === 0) {
                sel.disabled = true;
                sel.innerHTML = "<option>Sin categorías</option>";
                return;
            }
            cats.forEach(c => {
                const o = document.createElement("option");
                o.textContent = c.nombre;
                sel.appendChild(o);
            });
            sel.disabled = false;
        }

        function cargarUbicaciones(idSelect) {
            const sel = document.getElementById(idSelect);
            sel.innerHTML = "";
            const cats = JSON.parse(localStorage.getItem("ubicaciones")) || [];
            if (idSelect == "filterBienUbicacion") {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Todas las ubicaciones";
                sel.appendChild(opt);
            }
            if (cats.length === 0) {
                sel.disabled = true;
                sel.innerHTML = "<option>Sin ubicaciones</option>";
                return;
            }
            cats.forEach(c => {
                const o = document.createElement("option");
                o.textContent = c.nombre;
                sel.appendChild(o);
            });
            sel.disabled = false;
        }

        recargarBienes();
        recargarCategorias();
        recargarUbicaciones();
        recargarEventos();

        cargarCategorias("categoriasSugeridas");
        cargarUbicaciones("ubicacionesSugeridas");

        renderInventario();

        document.getElementById("filterBienInput").oninput = renderInventario;
        document.getElementById("filterBienCategoria").oninput = renderInventario;
        document.getElementById("filterBienEstado").onchange = renderInventario;
        document.getElementById("filterBienUbicacion").oninput = renderInventario

        document.getElementById("productoForm").onsubmit = async (e) => {
            e.preventDefault();
            const nombre = document.getElementById("nombreProducto").value.trim().toUpperCase();
            const ubicacion = ubicacionProducto.value.toUpperCase();
            const categoria = categoriaProducto.value.toUpperCase();
            const cantBienes = +document.getElementById("stockInicial").value;
            const detalleInput = document.getElementById("detalleProducto").value.trim().toUpperCase();
            const detalle = detalleInput === "" ? null : detalleInput;

            // Validación básica
            if (!nombre || !categoria || !ubicacion || cantBienes < 1) {
                alert("Datos incompletos.");
                return;
            }

            const bien = {
                nombre,
                nombreCatBienes: categoria,
                ubicacionBien: ubicacion,
                cantBienes,
                ...(detalle ? { detalle } : {})
            };

            try {
                const response = await crearBien(bien);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    } else {
                        alert(`El servidor no pudo realizar el registro del bien. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            if (cantBienes > 1) { alert(`${cantBienes} bienes registrados.`); }
            else { alert("Bien registrado."); }
            await recargarBienes();
            await recargarCategorias();
            await recargarUbicaciones();
            await recargarEventos();

            // Reiniciamos el form y lo preparamos para nuevos inserts
            cargarCategorias("categoriasSugeridas");
            cargarUbicaciones("ubicacionesSugeridas");
            renderInventario();
            e.target.reset();
        };

        function editarBien(id) {
            const bienes = JSON.parse(localStorage.getItem("bienes")) || [];
            const bien = bienes.find(b => b.id_Bien === id);
            if (!bien) return;

            modBienId.value = bien.id_Bien;
            modNombre.value = bien.nombre;
            modCategoria.value = bien.nombreCatBienes;
            modUbicacion.value = bien.ubicacionBien;
            modDetalleProducto.value = bien.detalle ? bien.detalle : "";

            document.getElementById("modificarBienSection").classList.remove("hidden");
        }

        document.getElementById("modificarBienForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = modBienId.value;
            let bien;
            try {
                const response = await leerBien(id);
                if (!response.ok) {
                    document.getElementById("modificarBienSection").classList.add("hidden");
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 404) {
                        alert("Bien no encontrado.");
                        return;
                    }
                    else if (response.status == 500) {
                        alert("El servidor no pudo realizar la búsqueda del bien. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la búsqueda del bien. Código: ${response.status}`);
                        return;
                    }
                }
                bien = await response.json();
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            const modDetalleTempInput = modDetalleProducto.value.trim().toUpperCase();
            const modDetalleTemp = modDetalleTempInput === "" ? null : modDetalleTempInput;

            const bienModificado = {
                nombre: modNombre.value.toUpperCase().trim(),
                nombreCatBienes: modCategoria.value.toUpperCase(),
                ubicacionBien: modUbicacion.value.toUpperCase(),
                ...(modDetalleTemp ? { detalle: modDetalleTemp } : {})
            };

            try {
                const response = await modificarBien(bienModificado, id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 404) {
                        alert("Bien no encontrado.");
                        return;
                    }
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la modificación del bien. Código: 500");
                        return;
                    } else {
                        alert(`El servidor no pudo realizar la modificación del bien. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            alert("Bien actualizado.");
            await recargarBienes();
            await recargarCategorias();
            await recargarUbicaciones();
            await recargarEventos();

            cargarCategorias("categoriasSugeridas");
            cargarUbicaciones("ubicacionesSugeridas");
            renderInventario();
            document.getElementById("modificarBienSection").classList.add("hidden");
            e.target.reset();
        });

        document.getElementById("eliminarBienBtn").addEventListener("click", async () => {
            const id = modBienId.value;
            if (!confirm("¿Eliminar este bien?")) return;

            try {
                const response = await eliminarBien(id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la eliminación del bien. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la eliminación del bien. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Bien eliminado.");
            await recargarBienes();
            renderInventario();
            document.getElementById("modificarBienSection").classList.add("hidden");
            document.getElementById("modificarBienForm").reset();
        });

        // Cancelar edición de datos
        document.getElementById("cancelarBtn").onclick = () => {
            if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                document.getElementById("modificarBienSection").classList.add("hidden");
                document.getElementById("modificarBienForm").reset();
            }
        };

        renderInventario();
    </script>

</body>

</html>