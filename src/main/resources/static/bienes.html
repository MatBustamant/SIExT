<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestionar bienes - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="icon" href="images\icon.png">
    <style>
        :root {
            --modificar-bg: #e9f0ff;
            --modificar-border: #8ab4f8;
        }

        .modificar-container {
            margin-top: 1rem;
            padding: 1.5rem;
            background-color: var(--modificar-bg);
            border: 2px solid var(--modificar-border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(27, 84, 255, 0.15);
        }

        #datosProductoEncontrado {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 1rem;
        }

        #datosProductoEncontrado p {
            margin: 0;
        }

        .modificar-container h3 {
            margin-bottom: 1rem;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <header>
        <span>SIExT | Gestionar bienes</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="categorias.html" class="btn"><i class="bi bi-tags"></i>Editar Categorías</a></li>
                <li><a href="ubicaciones.html" class="btn"><i class="bi bi-geo-alt"></i>Editar Ubicaciones</a></li>
                <li><a href="inventario.html" class="btn"><i class="bi bi-card-list"></i></i>Listar Inventario</a></li>
                <li><a href="eventos.html" class="btn"><i class="bi bi-exclamation-circle"></i>Registrar Eventos</a>
                </li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">
        <!-- Formulario registrar producto nuevo -->
        <section>
            <h2>Registrar nuevo bien</h2>
            <form id="productoForm">
                <div class="form-grid">
                    <div>
                        <label>Categoría</label>
                        <input list="categoriasSugeridas" type="text" id="categoriaProducto" required>
                        <datalist id="categoriasSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Nombre</label>
                        <input type="text" id="nombreProducto" required>
                    </div>
                    <div>
                        <label>Ubicación</label>
                        <input list="ubicacionesSugeridas" type="text" id="ubicacionProducto" required>
                        <datalist id="ubicacionesSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Cantidad</label>
                        <input type="number" id="stockInicial" min="1" value="1" required>
                    </div>
                </div>
                <div>
                    <label>Detalle</label>
                    <input type="text" id="detalleProducto" placeholder="Detalles extras opcionales...">
                </div>
                <div>
                    <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
                </div>
            </form>
        </section>

        <!-- Formulario buscar y modificar producto existente -->
        <section>
            <h2>Modificar bien existente</h2>
            <form id="busquedaForm">
                <label>Nro. de inventario</label>
                <div class="input-prefix">
                    <span>FCE-</span>
                    <input type="number" id="buscarId" required>
                </div>
                <button type="submit" class="btn"><i class="bi bi-search"></i>Buscar</button>
            </form>

            <div class="modificar-container hidden" id="modificarContenedor">
                <h3 id="tituloProductoEncontrado">Bien encontrado</h3>

                <!-- Datos actuales del producto -->
                <div id="datosProductoEncontrado" style="margin-bottom: 1rem; line-height: 1.5;"></div>

                <!-- Botones de acción -->
                <div class="btn-row">
                    <button type="button" class="btn" id="btnEditarDatos"><i class="bi bi-pencil-square"></i>Modificar
                        Datos</button>
                    <button type="button" class="btn btn-danger" id="eliminarProducto"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>

                <!-- Formulario Modificar Datos Generales -->
                <form id="formModificarDatos" class="hidden" style="margin-top: 1rem;">
                    <div>
                        <label>Categoría</label>
                        <input list="modCategoriasSugeridas" type="text" id="modCategoria" required>
                        <datalist id="modCategoriasSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Nombre</label>
                        <input type="text" id="modNombre" required>
                    </div>
                    <div>
                        <label>Ubicación</label>
                        <input list="modUbicacionesSugeridas" type="text" id="modUbicacion" required>
                        <datalist id="modUbicacionesSugeridas"></datalist>
                    </div>
                    <div>
                        <label>Detalle</label>
                        <input type="text" id="modDetalleProducto" placeholder="Detalles extras opcionales...">
                    </div>
                    <div class="btn-row">
                        <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                        <button type="button" class="btn" id="cancelarEdicionBtn"><i
                                class="bi bi-x-circle"></i>Cancelar</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>

    <script>
        const categoriaProducto = document.getElementById("categoriaProducto");
        const ubicacionProducto = document.getElementById("ubicacionProducto");
        const modNombre = document.getElementById("modNombre");
        const modCategoria = document.getElementById("modCategoria");
        const modUbicacion = document.getElementById("modUbicacion");
        const modDetalleProducto = document.getElementById("modDetalleProducto");
        const modificarForm = document.getElementById("modificarForm");
        const modificarContenedor = document.getElementById("modificarContenedor");

        function cargarCategorias(idSelect) {
            const sel = document.getElementById(idSelect);
            sel.innerHTML = "";
            const cats = JSON.parse(localStorage.getItem("categorias")) || [];
            if (cats.length === 0) {
                sel.disabled = true;
                sel.innerHTML = "<option>Sin categorías</option>";
                return;
            }
            cats.forEach(c => {
                const o = document.createElement("option");
                o.textContent = c.nombre;
                sel.appendChild(o);
            });
            sel.disabled = false;
        }

        function cargarUbicaciones(idSelect) {
            const sel = document.getElementById(idSelect);
            sel.innerHTML = "";
            const cats = JSON.parse(localStorage.getItem("ubicaciones")) || [];
            if (cats.length === 0) {
                sel.disabled = true;
                sel.innerHTML = "<option>Sin ubicaciones</option>";
                return;
            }
            cats.forEach(c => {
                const o = document.createElement("option");
                o.textContent = c.nombre;
                sel.appendChild(o);
            });
            sel.disabled = false;
        }

        recargarBienes();
        recargarCategorias();
        recargarUbicaciones();
        recargarEventos();

        cargarCategorias("categoriasSugeridas");
        cargarUbicaciones("ubicacionesSugeridas");
        cargarCategorias("modCategoriasSugeridas");
        cargarUbicaciones("modUbicacionesSugeridas");

        document.getElementById("productoForm").onsubmit = async (e) => {
            e.preventDefault();
            const nombre = document.getElementById("nombreProducto").value.trim().toUpperCase();
            const ubicacion = ubicacionProducto.value.toUpperCase();
            const categoria = categoriaProducto.value.toUpperCase();
            const cantBienes = +document.getElementById("stockInicial").value;
            const detalleInput = document.getElementById("detalleProducto").value.trim().toUpperCase();
            const detalle = detalleInput === "" ? null : detalleInput;

            // Validación básica
            if (!nombre || !categoria || !ubicacion || cantBienes < 1) {
                alert("Datos incompletos.");
                return;
            }

            const bien = {
                nombre,
                nombreCatBienes: categoria,
                ubicacionBien: ubicacion,
                cantBienes,
                ...(detalle ? { detalle } : {})
            };

            try {
                const response = await crearBien(bien);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    } else {
                        alert(`El servidor no pudo realizar el registro del bien. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            if (cantBienes > 1) { alert(`${cantBienes} bienes registrados.`); }
            else { alert("Bien registrado."); }
            await recargarBienes();
            await recargarCategorias();
            await recargarUbicaciones();
            await recargarEventos();

            // Reiniciamos el form y lo preparamos para nuevos inserts
            cargarCategorias("categoriasSugeridas");
            cargarUbicaciones("ubicacionesSugeridas");
            cargarCategorias("modCategoriasSugeridas");
            cargarUbicaciones("modUbicacionesSugeridas");
            e.target.reset();
        };
    </script>
    <script src="js/formateo.js"></script>
    <script>
        let bienIdActual = null;
        // Al buscar producto:
        document.getElementById("busquedaForm").onsubmit = async (e) => {
            e.preventDefault();
            const id = +document.getElementById("buscarId").value;
            let bien;
            try {
                const response = await leerBien(id);
                bienIdActual = id;
                if (!response.ok) {
                    modificarContenedor.classList.add("hidden");
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 404) {
                        alert("Bien no encontrado.");
                        return;
                    }
                    else if (response.status == 500) {
                        alert("El servidor no pudo realizar la búsqueda del bien. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la búsqueda del bien. Código: ${response.status}`);
                        return;
                    }
                }
                bien = await response.json();
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            nroInventarioActual = formatearNroBien(bienIdActual);

            modificarContenedor.classList.remove("hidden");
            // Mostrar todos los datos actuales
            const datosHTML = `
                <p><strong>Nombre:</strong> ${bien.nombre}</p>
                <p><strong>Categoría:</strong> ${bien.nombreCatBienes}</p>
                <p><strong>Estado:</strong> ${(bien.estadoBien).replace("_", " ")}</p>
                <p><strong>Ubicación:</strong> ${bien.ubicacionBien}</p>
                <p><strong>Detalle:</strong> ${bien.detalle ? bien.detalle : "Sin detalles"}</p>
                `;
            const titulo = `Bien con nro. de inventario "${nroInventarioActual}" encontrado`;
            document.getElementById("tituloProductoEncontrado").textContent = titulo;
            document.getElementById("datosProductoEncontrado").innerHTML = datosHTML;

            // Ocultar formularios
            document.getElementById("formModificarDatos").classList.add("hidden");

            // Botón eliminar producto
            document.getElementById("eliminarProducto").onclick = async () => {
                if (!confirm("¿Eliminar bien?")) return;
                try {
                    const response = await eliminarBien(bienIdActual);
                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status == 422) {
                            alert(errorData.error);
                            return;
                        }
                        if (response.status == 500) {
                            alert("El servidor no pudo realizar la eliminación del bien. Código: 500");
                            return;
                        }
                        else {
                            alert(`El servidor no pudo realizar la eliminación del bien. Código: ${response.status}`);
                            return;
                        }
                    }
                } catch (error) {
                    alert("No se pudo conectar con el servidor.");
                    return;
                }
                alert("Bien eliminado.");
                modificarContenedor.classList.add("hidden");
                await recargarBienes();
            };

            // Mostrar form de edición de datos
            document.getElementById("btnEditarDatos").onclick = () => {
                document.getElementById("formModificarDatos").classList.remove("hidden");
                document.getElementById("tituloProductoEncontrado").textContent = "Modificar Datos del Bien";
                modNombre.value = bien.nombre;
                modCategoria.value = bien.nombreCatBienes;
                modUbicacion.value = bien.ubicacionBien;
                modDetalleProducto.value = bien.detalle ? bien.detalle : "";
                ocultarInfoYAcciones();
            };

            // Guardar cambios de datos generales
            document.getElementById("formModificarDatos").onsubmit = async (ev) => {
                ev.preventDefault();

                const modDetalleTempInput = modDetalleProducto.value.trim().toUpperCase();
                const modDetalleTemp = modDetalleTempInput === "" ? null : modDetalleTempInput;

                const bienModificado = {
                    nombre: modNombre.value.toUpperCase().trim(),
                    nombreCatBienes: modCategoria.value.toUpperCase(),
                    ubicacionBien: modUbicacion.value.toUpperCase(),
                    ...(modDetalleTemp ? { detalle: modDetalleTemp } : {})
                };

                try {
                    const response = await modificarBien(bienModificado, bienIdActual);
                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status == 422) {
                            alert(errorData.error);
                            return;
                        }
                        if (response.status == 500) {
                            alert("El servidor no pudo realizar la modificación del bien. Código: 500");
                            return;
                        } else {
                            alert(`El servidor no pudo realizar la modificación del bien. Código: ${response.status}`);
                            return;
                        }
                    }
                } catch (error) {
                    alert("No se pudo conectar con el servidor.");
                    return;
                }

                alert("Bien actualizado.");
                await recargarBienes();
                await recargarCategorias();
                await recargarUbicaciones();
                await recargarEventos();

                cargarCategorias("categoriasSugeridas");
                cargarUbicaciones("ubicacionesSugeridas");
                cargarCategorias("modCategoriasSugeridas");
                cargarUbicaciones("modUbicacionesSugeridas");
                mostrarInfoYAcciones(nroInventarioActual);
                document.getElementById("formModificarDatos").classList.add("hidden");
                modificarContenedor.classList.add("hidden");
                ev.target.reset();
            };

            // Cancelar edición de datos
            document.getElementById("cancelarEdicionBtn").onclick = () => {
                if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                    document.getElementById("formModificarDatos").classList.add("hidden");
                    mostrarInfoYAcciones(nroInventarioActual);
                }
            };
        };

    </script>

    <script>
        function ocultarInfoYAcciones() {
            document.getElementById("datosProductoEncontrado").classList.add("hidden");
            document.querySelector(".btn-row").classList.add("hidden");
        }

        function mostrarInfoYAcciones(id) {
            document.getElementById("datosProductoEncontrado").classList.remove("hidden");
            document.querySelector(".btn-row").classList.remove("hidden");
            document.getElementById("tituloProductoEncontrado").textContent = `Bien con nro. de inventario "${id}" encontrado`;
        }
    </script>
</body>

</html>