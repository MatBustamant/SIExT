<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ver inventario - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images\icon.png">
    <style>
        label {
            display: inline-block;
        }

        input[type="checkbox"] {
            width: auto;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
        }

        .badge.disponible {
            background-color: var(--verde);
        }

        .badge.averiado {
            background-color: var(--rojo);
        }

        .badge.reservado {
            background-color: var(--amarillo);
            color: var(--negro);
        }
    </style>
</head>

<body>
    <header>
        <span>SIExT | Ver inventario</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="bienes.html" class="btn"><i class="bi bi-box-seam"></i></i>Gestionar Bienes</a></li>
                <li><a href="informes.html" class="btn"><i class="bi bi-file-earmark-text"></i>Generar Informes</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">
        <!-- Listado de bienes -->
        <section>
            <h2>Bienes</h2>
            <div class="form-grid">
                <div>
                    <input type="text" id="filterBienInput" placeholder="Filtrar por nombre o ID...">
                </div>
                <div>
                    <select id="filterBienCategoria"></select>
                </div>
                <div>
                    <select id="filterBienEstado">
                        <option value="">Todos los estados</option>
                        <option value="EN_CONDICIONES">EN CONDICIONES</option>
                        <option value="AVERIADO">AVERIADO</option>
                    </select>
                </div>
                <div>
                    <input type="text" id="filterBienUbicacion" placeholder="Filtrar por ubicación..."></select>
                </div>
            </div>
            <table id="bienesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Estado</th>
                        <th>Ubicación</th>
                    </tr>
                </thead>

                <tbody></tbody>
            </table>
            <div class="informativo" id="counterBienes"></div>
        </section>
    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            recargarBienes();
            recargarCategorias();
        });
    </script>
    <script>
        function cargarCategorias() {
            const categorias = JSON.parse(localStorage.getItem("categorias")) || [];
            const productos = JSON.parse(localStorage.getItem("productos")) || [];

            const bienSelect = document.getElementById("filterBienCategoria");

            bienSelect.innerHTML = '<option value="">Todas las categorías</option>';

            // Solo categorías con Bienes
            // const categoriasBienes = [...new Set(productos.filter(p => p.clase === "Bien").map(p => p.categoria))];
            categorias.forEach(cat => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = cat.nombre;
                bienSelect.appendChild(opt);
            });
        }


        function renderInventario() {
            const bienes = JSON.parse(localStorage.getItem("bienes")) || [];
            const categorias = JSON.parse(localStorage.getItem("categorias")) || [];

            const bienFiltroTexto = document.getElementById("filterBienInput").value.toUpperCase();
            const bienFiltroCategoria = document.getElementById("filterBienCategoria").value;
            const bienFiltroEstado = document.getElementById("filterBienEstado").value;
            const bienFiltroUbicacion = document.getElementById("filterBienUbicacion").value.toUpperCase();

            const bienesTable = document.getElementById("bienesTable").querySelector("tbody");
            bienesTable.innerHTML = "";

            let countBienes = 0;

            bienes.forEach(prod => {
                const matchTexto = txt => prod.nombre.toUpperCase().includes(txt) || String(prod.id_Bien).includes(txt);
                const matchCategoria = (cat, filtro) => !filtro || cat === filtro;
                const matchEstado = (estado, filtro) => !filtro || estado === filtro;
                const matchUbicacion = (ubicacion, filtro) => !filtro || ubicacion.toUpperCase().includes(filtro);

                if (matchTexto(bienFiltroTexto) && matchCategoria(prod.nombreCatBienes, bienFiltroCategoria)
                    && matchEstado(prod.estadoBien, bienFiltroEstado)
                    && matchUbicacion(prod.ubicacionBien, bienFiltroUbicacion)
                ) {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${prod.id_Bien}</td>
                    <td>${prod.nombre}</td>
                    <td>${prod.nombreCatBienes}</td>
                <td><span class="badge ${prod.estadoBien === "EN_CONDICIONES" ? 'disponible' : 'averiado'}">${(prod.estadoBien).replace("_", " ")}</span></td>
                <td>${prod.ubicacionBien}</td>`;
                    bienesTable.appendChild(row);
                    countBienes++;
                }
            });

            document.getElementById("counterBienes").textContent = `Mostrando ${countBienes} bien(es).`;
        }


        document.querySelectorAll("input, select").forEach(el => el.addEventListener("input", renderInventario));

        cargarCategorias();
        renderInventario();
    </script>
</body>

</html>