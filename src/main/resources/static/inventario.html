<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inventario - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link href="css/global.css" rel="stylesheet" />
    <link rel="icon" href="images\icon.png">
    <style>
        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
        }

        .badge.disponible {
            background-color: var(--verde);
        }

        .badge.averiado {
            background-color: var(--rojo);
        }

        .badge.reservado {
            background-color: var(--amarillo);
            color: var(--negro);
        }
    </style>
</head>

<body>
    <header>SIExT | Inventario</header>

    <main>
        <section class="cabecera">
            <h2>Acciones rápidas</h2>
            <div>
                <a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a>
                <a href="productos.html" class="btn"><i class="bi bi-box-seam"></i></i>Gestionar Productos</a>
                <a href="informes.html" class="btn"><i class="bi bi-file-earmark-text"></i>Generar Informes</a>
            </div>
        </section>

        <section>
            <h3>Insumos</h3>
            <div class="filters">
                <input type="text" id="filterInsumoInput" placeholder="Filtrar por nombre o ID...">
                <select id="filterInsumoCategoria"></select>
                <select id="filterInsumoClase"></select>
                <label><input type="checkbox" id="filterInsumoReposicion"> Solo a reponer</label>
            </div>

            <table id="insumosTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Clase</th>
                        <th>Stock</th>
                        <th>Mínimo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="counter" id="counterInsumos"></div>
        </section>

        <section>
            <h3>Bienes</h3>
            <div class="filters">
                <input type="text" id="filterBienInput" placeholder="Filtrar por nombre o ID...">
                <select id="filterBienCategoria"></select>
                <label><input type="checkbox" id="filterBienReposicion"> Solo a reponer</label>
            </div>
            <table id="bienesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Estado</th>
                        <th>Ubicación</th>
                    </tr>
                </thead>

                <tbody></tbody>
            </table>
            <div class="counter" id="counterBienes"></div>
        </section>
    </main>

    <footer>SIExT | 2025</footer>

    <script>
        function cargarCategorias() {
            const categorias = JSON.parse(localStorage.getItem("categorias")) || [];
            const productos = JSON.parse(localStorage.getItem("productos")) || [];

            const insumoSelect = document.getElementById("filterInsumoCategoria");
            const bienSelect = document.getElementById("filterBienCategoria");
            const insumoClaseSelect = document.getElementById("filterInsumoClase");

            insumoSelect.innerHTML = '<option value="">Todas las categorías</option>';
            bienSelect.innerHTML = '<option value="">Todas las categorías</option>';
            insumoClaseSelect.innerHTML = '<option value="">Todas las clases</option>';

            categorias.forEach(cat => {
                const opt1 = document.createElement("option");
                opt1.value = opt1.textContent = cat.nombre;
                insumoSelect.appendChild(opt1);
            });

            // Solo categorías con Bienes
            const categoriasBienes = [...new Set(productos.filter(p => p.clase === "Bien").map(p => p.categoria))];
            categoriasBienes.forEach(catNombre => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = catNombre;
                bienSelect.appendChild(opt);
            });

            // Clases de Insumos
            const clasesInsumos = [...new Set(productos.filter(p => p.clase !== "Bien").map(p => p.clase))];
            clasesInsumos.forEach(clase => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = clase;
                insumoClaseSelect.appendChild(opt);
            });
        }


        function renderInventario() {
            const productos = JSON.parse(localStorage.getItem("productos")) || [];
            const categorias = JSON.parse(localStorage.getItem("categorias")) || [];

            const insumoFiltroTexto = document.getElementById("filterInsumoInput").value.toUpperCase();
            const insumoFiltroCategoria = document.getElementById("filterInsumoCategoria").value;
            const insumoFiltroClase = document.getElementById("filterInsumoClase").value;
            const insumoReposicion = document.getElementById("filterInsumoReposicion").checked;

            const bienFiltroTexto = document.getElementById("filterBienInput").value.toUpperCase();
            const bienFiltroCategoria = document.getElementById("filterBienCategoria").value;
            const bienReposicion = document.getElementById("filterBienReposicion").checked;

            const insumosTable = document.getElementById("insumosTable").querySelector("tbody");
            const bienesTable = document.getElementById("bienesTable").querySelector("tbody");
            insumosTable.innerHTML = "";
            bienesTable.innerHTML = "";

            let countInsumos = 0, countBienes = 0;

            // --- Insumos individuales ---
            productos.forEach(prod => {
                const matchTexto = txt => prod.nombre.toUpperCase().includes(txt) || String(prod.id).includes(txt);
                const matchCategoria = (cat, filtro) => !filtro || prod.categoria === filtro;
                const necesitaReposicion = prod.stock <= prod.minimoReposicion;

                if (prod.clase !== "Bien") {
                    if (matchTexto(insumoFiltroTexto) && matchCategoria(prod.categoria, insumoFiltroCategoria)
                        && (!insumoFiltroClase || prod.clase === insumoFiltroClase)
                        && (!insumoReposicion || necesitaReposicion)) {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${prod.id}</td>
                    <td>${prod.nombre}</td>
                    <td>${prod.categoria}</td>
                    <td>${prod.clase}</td>
                    <td>${prod.stock}</td>
                    <td>${prod.minimoReposicion}</td>`;
                        insumosTable.appendChild(row);
                        countInsumos++;
                    }
                }
            });

            // --- Agrupar Bienes por categoría ---
            const bienesPorCategoria = {};

            productos.forEach(prod => {
                if (prod.clase === "Bien") {
                    const matchTexto = txt => prod.nombre.toUpperCase().includes(txt) || String(prod.id).includes(txt);
                    const matchCategoria = (cat, filtro) => !filtro || prod.categoria === filtro;

                    if (matchTexto(bienFiltroTexto) && matchCategoria(prod.categoria, bienFiltroCategoria)) {
                        if (!bienesPorCategoria[prod.categoria]) {
                            bienesPorCategoria[prod.categoria] = [];
                        }
                        bienesPorCategoria[prod.categoria].push(prod);
                    }
                }
            });

            // --- Render Bienes agrupados ---
            Object.keys(bienesPorCategoria).forEach(categoria => {
                const bienes = bienesPorCategoria[categoria];
                const cantidad = bienes.length;

                const catData = categorias.find(c => c.nombre === categoria);
                const minimo = catData ? catData.detalle.minimoReposicion : 0;

                // Si está tildado "solo a reponer" y no lo necesita, omitir
                if (bienReposicion && cantidad >= minimo) return;

                // Cabecera de categoría
                const headerRow = document.createElement("tr");
                headerRow.style.backgroundColor = "#e9ecef";
                headerRow.innerHTML = `
            <td colspan="5"><strong>${categoria}</strong> | Cantidad: ${cantidad} | Mínimo: ${minimo}</td>`;
                bienesTable.appendChild(headerRow);

                // Filas de bienes individuales
                bienes.forEach(prod => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                <td>${prod.id}</td>
                <td>${prod.nombre}</td>
                <td>${prod.categoria}</td>
                <td><span class="badge ${prod.estado === "En condiciones" ? 'disponible' : 'averiado'}">${prod.estado}</span></td>
                <td>${prod.ubicacion}</td>`;
                    bienesTable.appendChild(row);
                    countBienes++;
                });
            });

            document.getElementById("counterInsumos").textContent = `Mostrando ${countInsumos} insumo(s).`;
            document.getElementById("counterBienes").textContent = `Mostrando ${countBienes} bien(es).`;
        }


        document.querySelectorAll("input, select").forEach(el => el.addEventListener("input", renderInventario));

        cargarCategorias();
        renderInventario();
    </script>
</body>

</html>