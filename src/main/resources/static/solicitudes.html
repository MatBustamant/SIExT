<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestionar solicitudes - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images\icon.png">
    <style>
        .detalle-fila {
        background-color: #f9f9f9;
        }

        .detalle-contenido {
        padding: 10px 20px;
        font-size: 0.95em;
        line-height: 1.4em;
        border-top: 1px solid #ddd;
        }

        .hidden {
        display: none;
        }

        .pagination-controls {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
        font-size: 0.9em;
        }
    </style>
</head>

<body>
    <header>
        <span>SIExT | Gestionar solicitudes</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="ubicaciones.html" class="btn"><i class="bi bi-geo-alt"></i>Editar Ubicaciones</a></li>
                <li><a href="bienes.html" class="btn"><i class="bi bi-box-seam"></i>Gestionar Bienes</a></li>
                <li id="supervisor-only-accion" class="hidden"><a href="informes.html" class="btn"><i
                            class="bi bi-file-earmark-text"></i>Generar Informes</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">

        <!-- Formulario para registrar nueva solicitud -->
        <section>
            <h2>Registrar nueva solicitud</h2>
            <form id="solicitudForm">
                <label>Ubicación destino</label>
                <input list="ubicacionesSugeridas" type="text" id="ubicacion" required>
                <datalist id="ubicacionesSugeridas"></datalist>
                <label>Estado</label>
                <select id="estado" required>
                    <option value="POR_REVISAR">Pendiente de aprobación</option>
                    <option value="APROBADA">Aprobada</option>
                    <option value="DESAPROBADA">No aprobada</option>
                    <option value="SATISFECHA">Completada</option>
                </select>
                <label>Descripción</label>
                <textarea id="descripcion" rows="4" required></textarea>
                <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
            </form>
        </section>

        <!-- Gestión de solicitudes existentes -->
        <section>
            <h2>Solicitudes registradas</h2>
            <!-- Filtros -->
            <div class="form-grid">
                <div>
                    <input type="number" id="filterNroSolicitud" placeholder="Filtrar por nro de solicitud...">
                </div>
                <div>
                    <select id="filterUbicacion"></select>
                </div>
                <div>
                    <select id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="POR_REVISAR">Pendiente de aprobación</option>
                        <option value="APROBADA">Aprobada</option>
                        <option value="DESAPROBADA">No aprobada</option>
                        <option value="SATISFECHA">Completada</option>
                    </select>
                </div>
                <div>
                    <input type="date" id="filterFecha">
                </div>
            </div>

            <table id="tablaSolicitudes">
                <thead>
                    <tr>
                        <th></th>
                        <th>N° Solicitud</th>
                        <th>Fecha</th>
                        <th>Ubicación</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="pagination-controls">
                <button id="prevPage" class="btn"><i class="bi bi-chevron-left"></i> Anterior</button>
                <span id="pageInfo">Página 1 de 1</span>
                <button id="nextPage" class="btn">Siguiente <i class="bi bi-chevron-right"></i></button>
                <select id="rowsPerPageSelect">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                </select>
                <label for="rowsPerPageSelect">por página</label>
            </div>

            <div class="informativo" id="counterSolicitudes"></div>
        </section>

        <!-- Formulario para modificar solicitud seleccionada -->
        <section id="modificarSolicitudSection" class="hidden">
            <h2>Editar solicitud</h2>
            <form id="modificarSolicitudForm">
                <input type="hidden" id="modSolicitudId">
                <label>Ubicación destino</label>
                <input list="modUbicacionesSugeridas" type="text" id="modUbicacion" required>
                <datalist id="modUbicacionesSugeridas"></datalist>
                <label>Estado</label>
                <select id="modEstado" required>
                    <option value="POR_REVISAR">Pendiente de aprobación</option>
                    <option value="APROBADA">Aprobada</option>
                    <option value="DESAPROBADA">No aprobada</option>
                    <option value="SATISFECHA">Completada</option>
                </select>
                <label>Descripción</label>
                <textarea id="modDescripcion" rows="4" required></textarea>
                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="cancelarBtn"><i class="bi bi-x-circle"></i>Cancelar</button>
                    <button type="button" class="btn btn-danger" id="eliminarSolicitudBtn"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>

    </main>

    <footer>SIExT | 2025</footer>

    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
        mostrarSegunRol("SUPERVISOR");
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/fechas.js"></script>
    <script>
        recargarSolicitudes();
        recargarUbicaciones();

        let currentPage = 1;
        let rowsPerPage = parseInt(document.getElementById("rowsPerPageSelect").value, 10);
        let totalPages = 1;

        function renderSolicitudes() {
            const solicitudes = JSON.parse(localStorage.getItem("solicitudes")) || [];
            const solicitudesHabilitadas = solicitudes.filter(s => !s.eliminado);

            const filterNroSolicitud = document.getElementById("filterNroSolicitud");
            const filterUbicacion = document.getElementById("filterUbicacion");
            const filterEstado = document.getElementById("filterEstado");
            const filterFecha = document.getElementById("filterFecha");

            const tbody = document.querySelector("#tablaSolicitudes tbody");
            tbody.innerHTML = "";

            // Filtrado
            const filtradas = solicitudesHabilitadas.filter(sol => {
                const matchNumSolicitud = numero => !numero || String(sol.numSolicitud).includes(numero);
                const matchUbicacion = (ubi, filtro) => !filtro || ubi === filtro;
                const matchEstado = (est, filtro) => !filtro || est === filtro;
                const matchFecha = (fecha, filtro) => !filtro || formatearFechaLocal(fecha) === filtro;

                return (
                    matchNumSolicitud(filterNroSolicitud.value) &&
                    matchUbicacion(sol.ubicacionBienes, filterUbicacion.value) &&
                    matchEstado(sol.estado, filterEstado.value) &&
                    matchFecha(sol.fechaInicioSolicitud, filterFecha.value)
                );
            });

            // Paginación
            const totalRows = filtradas.length;
            totalPages = Math.ceil(totalRows / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginadas = filtradas.slice(startIndex, endIndex);

            if (paginadas.length === 0) {
                const filaVacia = document.createElement("tr");
                filaVacia.innerHTML = `<td colspan="6" class="text-center">(No hay resultados que coincidan)</td>`;
                tbody.appendChild(filaVacia);
            }

            paginadas.forEach(sol => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td><button class="btn btn-toggle" onclick="toggleDetalles(this)" title="Expandir detalles">
                            <i class="bi bi-caret-down-fill"></i></button></td>
                        <td>${sol.numSolicitud}</td>
                        <td>${formatearFechaHora(sol.fechaInicioSolicitud)}</td>
                        <td>${sol.ubicacionBienes}</td>
                        <td>${(sol.estado).replace(/_/g, " ")}</td>
                        <td>
                            <button class="btn" onclick="editarSolicitud(${sol.numSolicitud})" title="Editar solicitud"><i class="bi bi-pencil"></i></button>
                        </td>`;
                    tbody.appendChild(fila);

                    // Fila oculta de detalles
                    const detalle = document.createElement("tr");
                    detalle.classList.add("detalle-fila", "hidden");
                    detalle.innerHTML = `
                        <td colspan="6" class="detalle-contenido">
                            <p><strong>Descripción:</strong> ${sol.descripcion || "(Sin descripción)"}</p>
                            <p><strong>Fecha inicio:</strong> ${formatearFechaHora(sol.fechaInicioSolicitud)}</p>
                            <p><strong>Estado:</strong> ${(sol.estado).replace(/_/g, " ")}</p>
                            <p><strong>Ubicación destino:</strong> ${sol.ubicacionBienes}</p>
                        </td>
                    `;
                    tbody.appendChild(detalle);
                });

            document.getElementById("counterSolicitudes").textContent = `Mostrando ${paginadas.length} de ${totalRows} solicitud(es).`;
            document.getElementById("pageInfo").textContent = `Página ${currentPage} de ${totalPages || 1}`;
        }

        // Función para expandir/contraer detalle
        function toggleDetalles(button) {
            const fila = button.closest("tr");
            const siguiente = fila.nextElementSibling;
            if (siguiente && siguiente.classList.contains("detalle-fila")) {
                siguiente.classList.toggle("hidden");
                const icono = button.querySelector("i");
                icono.classList.toggle("bi-caret-down-fill");
                icono.classList.toggle("bi-caret-up-fill");
            }
        }

        // Controles de paginación
        document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderSolicitudes();
        }
        });

        document.getElementById("nextPage").addEventListener("click", () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderSolicitudes();
            }
        });

        document.getElementById("rowsPerPageSelect").addEventListener("change", (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderSolicitudes();
        });

        document.getElementById("filterNroSolicitud").addEventListener("input", renderSolicitudes);
        document.getElementById("filterUbicacion").addEventListener("change", renderSolicitudes);
        document.getElementById("filterEstado").addEventListener("change", renderSolicitudes);
        document.getElementById("filterFecha").addEventListener("change", renderSolicitudes);

        function cargarUbicaciones(idSelect) {
            const sel = document.getElementById(idSelect);
            sel.innerHTML = "";
            const cats = JSON.parse(localStorage.getItem("ubicaciones")) || [];
            if (idSelect == "filterUbicacion") {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Todas las ubicaciones";
                sel.appendChild(opt);
            }
            if (cats.length === 0) {
                sel.disabled = true;
                sel.innerHTML = "<option>Sin ubicaciones</option>";
                return;
            }
            cats.forEach(c => {
                const o = document.createElement("option");
                o.textContent = c.nombre;
                sel.appendChild(o);
            });
            sel.disabled = false;
        }

        cargarUbicaciones("ubicacionesSugeridas");
        cargarUbicaciones("modUbicacionesSugeridas");
        cargarUbicaciones("filterUbicacion");

        document.getElementById("solicitudForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const ubicacion = document.getElementById("ubicacion").value.trim().toUpperCase();
            const estado = document.getElementById("estado").value;
            const descripcion = document.getElementById("descripcion").value.trim();
            if (!ubicacion || !estado || !descripcion) {
                alert("Datos incompletos.");
                return;
            }

            const solicitud = {
                ubicacionBienes: ubicacion,
                estado: estado,
                descripcion: descripcion,
            }

            try {
                const response = await crearSolicitud(solicitud);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar el registro de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Solicitud registrada.");
            await recargarSolicitudes();
            await recargarUbicaciones();

            cargarUbicaciones("ubicacionesSugeridas");
            cargarUbicaciones("modUbicacionesSugeridas");
            cargarUbicaciones("filterUbicacion");
            renderSolicitudes();
            e.target.reset();
        });

        function editarSolicitud(id) {
            const solicitudes = JSON.parse(localStorage.getItem("solicitudes")) || [];
            const sol = solicitudes.find(s => s.numSolicitud === id);
            if (!sol) return;
            document.getElementById("modSolicitudId").value = sol.numSolicitud;
            document.getElementById("modUbicacion").value = sol.ubicacionBienes;
            document.getElementById("modEstado").value = sol.estado;
            document.getElementById("modDescripcion").value = sol.descripcion;
            document.getElementById("modificarSolicitudSection").classList.remove("hidden");
        }

        document.getElementById("modificarSolicitudForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = +document.getElementById("modSolicitudId").value;
            let solicitud;
            try {
                const response = await leerSolicitud(id);
                if (!response.ok) {
                    document.getElementById("modificarSolicitudSection").classList.add("hidden");
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 404) {
                        alert("Solicitud no encontrada.");
                        return;
                    }
                    else if (response.status == 500) {
                        alert("El servidor no pudo realizar la búsqueda de la solicitud. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la búsqueda de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
                solicitud = await response.json();
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            const solicitudModificada = {
                ubicacionBienes: document.getElementById("modUbicacion").value.trim().toUpperCase(),
                estado: document.getElementById("modEstado").value.toUpperCase(),
                descripcion: document.getElementById("modDescripcion").value.trim(),
            }

            try {
                const response = await modificarSolicitud(solicitudModificada, id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la modificación de la solicitud. Código: 500");
                        return;
                    } else {
                        alert(`El servidor no pudo realizar la modificación de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            alert("Solicitud actualizada.");
            await recargarSolicitudes();
            await recargarUbicaciones();

            cargarUbicaciones("ubicacionesSugeridas");
            cargarUbicaciones("modUbicacionesSugeridas");
            cargarUbicaciones("filterUbicacion");
            renderSolicitudes();
            document.getElementById("modificarSolicitudSection").classList.add("hidden");
            e.target.reset();
        });

        document.getElementById("eliminarSolicitudBtn").addEventListener("click", async () => {
            const id = +document.getElementById("modSolicitudId").value;
            if (!confirm("¿Eliminar esta solicitud?")) return;

            try {
                const response = await eliminarSolicitud(id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la eliminación de la solicitud. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la eliminación de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Solicitud eliminada.");
            await recargarSolicitudes();
            renderSolicitudes();
            document.getElementById("modificarSolicitudSection").classList.add("hidden");
            document.getElementById("modificarSolicitudForm").reset();
        });

        // Cancelar edición de datos
        document.getElementById("cancelarBtn").onclick = () => {
            if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                document.getElementById("modificarSolicitudSection").classList.add("hidden");
                document.getElementById("modificarSolicitudForm").reset();
            }
        };

        renderSolicitudes();
    </script>
</body>

</html>