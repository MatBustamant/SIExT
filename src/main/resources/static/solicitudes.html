<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestionar solicitudes - SIExT</title>
    <link href="icons/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/tablas.css">
    <link rel="icon" href="images/icon.png">
    <style>
        .lista-items-agregados {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .item-agregado {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #eee;
        }

        .item-agregado:last-child {
            border-bottom: none;
        }

        .item-agregado span {
            font-weight: 500;
        }

        .input-group-agregar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .input-group-agregar input[type="number"] {
            width: 90px;
            min-width: 70px;
            flex: 0 1 90px;
        }

        .btn-sm-quitar {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1;
            height: auto;
        }

        /* --- Estilos del Modal (Basados en tu ejemplo) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            /* Aumentamos la altura máxima para el selector */
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close-btn:hover {
            color: var(--rojo);
        }

        .modal-body {
            overflow-y: auto;
            flex: 1; /* Permite que el body ocupe el espacio */
        }

        .modal-footer {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* --- Estilos específicos para el modal de asignación --- */
        .modal-filtros {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        #resumenSeleccion p {
            margin: 0.5rem 0;
            font-size: 1rem;
        }
        
        #resumenSeleccion span.valido {
            color: var(--verde, green);
            font-weight: bold;
        }
        
        #resumenSeleccion span.invalido {
            color: var(--rojo, red);
            font-weight: bold;
        }

        #listaBienesDisponibles h4 {
            background-color: #f4f4f4;
            padding: 8px;
            border-radius: 4px;
            margin: 1rem 0 0.5rem 0;
        }

        .tabla-modal {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .tabla-modal th,
        .tabla-modal td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .tabla-modal th {
            font-weight: 600;
        }

        .tabla-modal th:first-child,
        .tabla-modal td:first-child {
            width: 40px; /* Checkbox */
            text-align: center;
        }
         .tabla-modal th:nth-child(2),
        .tabla-modal td:nth-child(2) {
             width: 100px; /* ID */
        }
    </style>
</head>

<body>
    <header>
        <span>SIExT | Gestionar solicitudes</span>
        <div id="userInfo" class="user-info">
            <span id="username"></span>
            <i class="bi bi-person-circle"></i>
            <div id="userMenu" class="user-menu hidden">
                <p id="userRole"><i id="rolIcon" class="bi bi-person-circle"></i></p>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <div class="default-block-container">
        <nav>
            <h2>Acciones rápidas</h2>
            <ul>
                <li><a href="panel.html" class="btn"><i class="bi bi-house"></i>Volver al Panel</a></li>
                <li><a href="ubicaciones.html" class="btn"><i class="bi bi-geo-alt"></i>Editar Ubicaciones</a></li>
                <li id="supervisor-only-accion" class="hidden"><a href="solicitantes.html" class="btn"><i class="bi bi-person-badge"></i></i>Editar Solicitantes</a></li>
                <li><a href="bienes.html" class="btn"><i class="bi bi-box-seam"></i>Gestionar Bienes</a></li>
                <li id="supervisor-only-accion" class="hidden"><a href="informes.html" class="btn"><i
                            class="bi bi-file-earmark-text"></i>Generar Informes</a></li>
            </ul>
        </nav>
    </div>

    <main class="default-block-container">

        <section>
            <h2>Registrar nueva solicitud</h2>
            <form id="solicitudForm">
                <label for="solicitante">Legajo de solicitante</label>
                <input type="number" id="solicitante" placeholder="23815432" min="1000000" max="99999999" required>
                <label for="ubicacion">Ubicación destino</label>
                <input list="ubicacionesSugeridas" type="text" id="ubicacion" placeholder="BEDELÍA" required>
                <datalist id="ubicacionesSugeridas"></datalist>
                <label>Items solicitados</label>
                <div class="input-group-agregar">
                    <input list="categoriasSugeridas" type="text" id="itemCategoria" placeholder="COMPUTADORAS" style="margin-bottom: 0;" />
                    <datalist id="categoriasSugeridas"></datalist>
                    <input type="number" id="itemCantidad" placeholder="Cant." min="1" style="margin-bottom: 0;" />
                    <button type="button" id="btnAgregarItem" class="btn" style="margin-bottom: 0;">Agregar</button>
                </div>
                <div id="listaItemsSolicitados" class="lista-items-agregados">
                    <small>No hay items agregados.</small>
                </div>
                <label for="descripcion">Descripción</label>
                <textarea id="descripcion" rows="4" placeholder="Detalles extra opcionales..."></textarea>
                <button type="submit" class="btn"><i class="bi bi-plus-circle"></i>Registrar</button>
            </form>
        </section>

        <section>
            <h2>Solicitudes registradas</h2>
            <div class="form-grid">
                <div>
                    <label for="filterNroSolicitud">Nro. de solicitud</label>
                    <input type="number" id="filterNroSolicitud" placeholder="Filtrar por nro de solicitud...">
                </div>
                <div>
                    <label for="filterSolicitante">Legajo de solicitante</label>
                    <input type="number" id="filterSolicitante" placeholder="Filtrar por solicitante...">
                </div>
                <div>
                    <label for="filterUbicacion">Ubicación</label>
                    <input list="ubicacionesSugeridas" type="text" id="filterUbicacion" placeholder="Filtrar por ubicación...">
                </div>
                <div>
                    <label for="filterEstado">Estado actual</label>
                    <select id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="POR_REVISAR">Pendiente de aprobación</option>
                        <option value="APROBADA">Aprobada</option>
                        <option value="DESAPROBADA">No aprobada</option>
                        <option value="SATISFECHA">Completada</option>
                    </select>
                </div>
                <div>
                    <label for="filterFecha">Fecha de solicitud</label>
                    <input type="date" id="filterFecha">
                </div>
            </div>

            <table id="tablaSolicitudes">
                <thead>
                    <tr>
                        <th></th>
                        <th>N° Solicitud</th>
                        <th>Fecha</th>
                        <th>Solicitante</th>
                        <th>Ubicación</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="pagination-controls">
                <button id="prevPage" class="btn"><i class="bi bi-chevron-left"></i> Anterior</button>
                <span id="pageInfo">Página 1 de 1</span>
                <button id="nextPage" class="btn">Siguiente <i class="bi bi-chevron-right"></i></button>
                <select id="rowsPerPageSelect">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="20">20</option>
                    <option value="25">25</option>
                    <option value="30">30</option>
                </select>
                <label for="rowsPerPageSelect">por página</label>
            </div>

            <div class="informativo" id="counterSolicitudes"></div>
        </section>

        <section id="modificarSolicitudSection" class="hidden">
            <h2>Editar solicitud</h2>
            <form id="modificarSolicitudForm">
                <label for="modSolicitudId">Nro. de solicitud</label>
                <input type="number" id="modSolicitudId" disabled>
                <label for="modSolicitante">Legajo de solicitante</label>
                <input type="number" id="modSolicitante" placeholder="23815432" min="1000000" max="99999999" required>
                <label for="modUbicacion">Ubicación destino</label>
                <input list="ubicacionesSugeridas" type="text" id="modUbicacion" placeholder="BEDELÍA" required>
                <label for="modEstado">Estado</label>
                <select id="modEstado" required>
                    <option value="POR_REVISAR">Pendiente de aprobación</option>
                    <option value="APROBADA">Aprobada</option>
                    <option value="DESAPROBADA">No aprobada</option>
                    <option value="SATISFECHA">Completada</option>
                </select>
                <label>Items solicitados</label>
                <div class="input-group-agregar">
                    <input list="categoriasSugeridas" type="text" id="modItemCategoria" placeholder="Ej: IMPRESORA" style="margin-bottom: 0;" />
                    <input type="number" id="modItemCantidad" placeholder="Cant." min="1" style="margin-bottom: 0;" />
                    <button type="button" id="btnModAgregarItem" class="btn" style="margin-bottom: 0;">Agregar</button>
                </div>
                <div id="modListaItemsSolicitados" class="lista-items-agregados">
                    <small>No hay items agregados.</small>
                </div>
                <label for="modDescripcion">Descripción</label>
                <textarea id="modDescripcion" rows="4" placeholder="Detalles extra opcionales..."></textarea>
                <div class="btn-row">
                    <button type="submit" class="btn"><i class="bi bi-save"></i>Guardar</button>
                    <button type="button" class="btn" id="cancelarBtn"><i class="bi bi-x-circle"></i>Cancelar</button>
                    <button type="button" class="btn btn-danger" id="eliminarSolicitudBtn"><i
                            class="bi bi-trash"></i>Eliminar</button>
                </div>
            </form>
        </section>

    </main>

    <footer>SIExT | 2025</footer>

    <div id="asignarBienesModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Asignar Bienes para Completar</h2>
                <button id="btnModalCerrar" class="modal-close-btn" title="Cerrar">&times;</button>
            </div>
            
            <div class="modal-body">
                
                <div id="resumenSeleccion">
                    </div>
                
                <hr>

                <div class="modal-filtros">
                    <div>
                        <label for="filterModalNombre">Nombre</label>
                        <input type="text" id="filterModalNombre" placeholder="Filtrar por nombre...">
                    </div>
                    <div>
                        <label for="filterModalInventario">Nro. de inventario</label>
                        <div class="input-prefix">
                            <span>FCE-</span>
                            <input type="number" id="filterModalInventario" placeholder="Filtrar por nro...">
                        </div>
                    </div>
                </div>

                <div id="listaBienesDisponibles">
                    </div>

            </div>

            <div class="modal-footer">
                <button id="btnModalCancelar" class="btn">Cancelar</button>
                <button id="btnModalContinuar" class="btn" disabled>Continuar</button>
            </div>
        </div>
    </div>
    <script src="js/auth.js"></script>
    <script>
        verificarAuth();
        mostrarSegunRol("SUPERVISOR");
    </script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/fechas.js"></script>
    <script src="js/forms.js"></script>
    <script src="js/formateo.js"></script>t
    <script src="js/completarSolicitud.js"></script>
    <script>
        recargarSolicitudes();
        recargarUbicaciones();
        recargarCategorias();

        let itemsSolicitados = [];
        let modItemsSolicitados = [];

        /**
         * Renderiza la lista de items para el formulario de CREAR.
         */
        function renderItemsCreate() {
            const cont = document.getElementById("listaItemsSolicitados");
            cont.innerHTML = ""; // Limpiar
            if (itemsSolicitados.length === 0) {
                cont.innerHTML = "<small>No hay items agregados.</small>";
                return;
            }

            itemsSolicitados.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "item-agregado";
                div.innerHTML = `
                    <span>${item.cantidad} &times; ${item.categoria.toUpperCase()}</span>
                    <button type="button" class="btn btn-danger btn-sm-quitar" data-index="${index}" title="Quitar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                // Listener para el botón de quitar
                div.querySelector("button").addEventListener("click", () => {
                    itemsSolicitados.splice(index, 1); // Quitar del array
                    renderItemsCreate(); // Re-renderizar
                });
                cont.appendChild(div);
            });
        }

        /**
         * Renderiza la lista de items para el formulario de MODIFICAR.
         */
        function renderItemsMod() {
            const cont = document.getElementById("modListaItemsSolicitados");
            cont.innerHTML = ""; // Limpiar
            if (modItemsSolicitados.length === 0) {
                cont.innerHTML = "<small>No hay items agregados.</small>";
                return;
            }

            modItemsSolicitados.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "item-agregado";
                div.innerHTML = `
                    <span>${item.cantidad} &times; ${item.categoria.toUpperCase()}</span>
                    <button type="button" class="btn btn-danger btn-sm-quitar" data-index="${index}" title="Quitar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                // Listener para el botón de quitar
                div.querySelector("button").addEventListener("click", () => {
                    modItemsSolicitados.splice(index, 1); // Quitar del array
                    renderItemsMod(); // Re-renderizar
                });
                cont.appendChild(div);
            });
        }

        document.getElementById("btnAgregarItem").addEventListener("click", () => {
            const categoriaInput = document.getElementById("itemCategoria");
            const cantidadInput = document.getElementById("itemCantidad");

            const categoria = categoriaInput.value.trim().toUpperCase();
            const cantidad = parseInt(cantidadInput.value);

            if (!categoria) {
                alert("Ingresá el nombre de la categoría o item.");
                categoriaInput.focus();
                return;
            }
            if (isNaN(cantidad) || cantidad < 1) {
                alert("Ingresá una cantidad válida (mayor a 0).");
                cantidadInput.focus();
                return;
            }

            // Opcional: chequear duplicados
            if (itemsSolicitados.find(item => item.categoria === categoria)) {
                alert("Esa categoría ya fue agregada. Podés borrarla y volver a agregarla con otra cantidad.");
                return;
            }

            itemsSolicitados.push({ categoria: categoria, cantidad: cantidad });
            renderItemsCreate();

            // Limpiar inputs
            categoriaInput.value = "";
            cantidadInput.value = "";
            categoriaInput.focus();
        });

        // Listener para el botón "Agregar" del formulario de MODIFICACIÓN
        document.getElementById("btnModAgregarItem").addEventListener("click", () => {
            const categoriaInput = document.getElementById("modItemCategoria");
            const cantidadInput = document.getElementById("modItemCantidad");

            const categoria = categoriaInput.value.trim().toUpperCase();
            const cantidad = parseInt(cantidadInput.value);

            if (!categoria) {
                alert("Ingresá el nombre de la categoría o item.");
                categoriaInput.focus();
                return;
            }
            if (isNaN(cantidad) || cantidad < 1) {
                alert("Ingresá una cantidad válida (mayor a 0).");
                cantidadInput.focus();
                return;
            }

            // Opcional: chequear duplicados
            if (modItemsSolicitados.find(item => item.categoria === categoria)) {
                alert("Esa categoría ya fue agregada. Podés borrarla y volver a agregarla con otra cantidad.");
                return;
            }

            modItemsSolicitados.push({ categoria: categoria, cantidad: cantidad });
            renderItemsMod();

            // Limpiar inputs
            categoriaInput.value = "";
            cantidadInput.value = "";
            categoriaInput.focus();
        });

        let currentPage = 1;
        let rowsPerPage = parseInt(document.getElementById("rowsPerPageSelect").value, 10);
        let totalPages = 1;

        function renderSolicitudes() {
            const solicitudes = JSON.parse(localStorage.getItem("solicitudes")) || [];
            const solicitudesHabilitadas = solicitudes.filter(s => !s.eliminado);

            const solicitantes = JSON.parse(localStorage.getItem("solicitantes")) || [];

            const filterNroSolicitud = document.getElementById("filterNroSolicitud").value;
            const filterUbicacion = document.getElementById("filterUbicacion").value.toUpperCase().trim();
            const filterEstado = document.getElementById("filterEstado").value;
            const filterFecha = document.getElementById("filterFecha").value;
            const filterLegajo = document.getElementById("filterSolicitante").value;

            const tbody = document.querySelector("#tablaSolicitudes tbody");
            tbody.innerHTML = "";

            // Filtrado
            const filtradas = solicitudesHabilitadas.filter(sol => (
                matchNumero(sol.numSolicitud, filterNroSolicitud)
                && matchTexto(sol.ubicacionBienes, filterUbicacion)
                && matchValor(sol.estado, filterEstado)
                && matchFecha(sol.fechaInicioSolicitud, filterFecha)
                && matchNumero(sol.solicitante, filterLegajo)
            ));

            // Paginación
            const totalRows = filtradas.length;
            totalPages = Math.ceil(totalRows / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginadas = filtradas.slice(startIndex, endIndex);

            if (paginadas.length === 0) {
                const filaVacia = document.createElement("tr");
                filaVacia.innerHTML = `<td colspan="7" class="text-center">(No hay resultados que coincidan)</td>`;
                tbody.appendChild(filaVacia);
            }

            paginadas.forEach(sol => {
                    const solicitante = solicitantes.find(persona => persona.legajo === sol.solicitante);
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td>
                            <button class="btn btn-toggle btn-icon-table" title="Expandir detalles">
                                <i class="bi bi-caret-down-fill"></i>
                            </button>
                        </td>
                        <td>${sol.numSolicitud}</td>
                        <td>${formatearFechaLocalEsp(sol.fechaInicioSolicitud)}</td>
                        <td>${sol.solicitante}</td>
                        <td>${sol.ubicacionBienes}</td>
                        <td>${(sol.estado).replace(/_/g, " ")}</td>
                        <td>
                            <button class="btn btn-editar btn-icon-table" data-id="${sol.numSolicitud}" title="Editar solicitud">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                        </td>`;
                    tbody.appendChild(fila);

                    // Fila oculta de detalles
                    const detalle = document.createElement("tr");
                    detalle.classList.add("detalle-fila", "hidden");
                    detalle.innerHTML = `
                        <td colspan="7" class="detalle-contenido">
                            <p><strong>Momento en que se registró:</strong> ${formatearFechaLocalLegible(sol.fechaInicioSolicitud)}</p>
                            <p><strong>Nombre de solicitante:</strong> ${solicitante ? solicitante.nombre : "N/A"}</p>
                            <p><strong>Bienes pedidos:</strong> ${(sol.bienesPedidos).map(item => `${item.cantidad}x ${item.categoria}`).join(", ")}</p>
                            <p><strong>Detalle:</strong> ${sol.descripcion || "(Sin detalle adicional)"}</p>
                        </td>
                    `;
                    tbody.appendChild(detalle);
                });

            document.getElementById("counterSolicitudes").textContent = `Mostrando ${paginadas.length} de ${totalRows} solicitud(es).`;
            document.getElementById("pageInfo").textContent = `Página ${currentPage} de ${totalPages || 1}`;

            document.getElementById("prevPage").disabled = (currentPage === 1);
            document.getElementById("nextPage").disabled = (currentPage === totalPages || totalPages === 0);
        }

        // Función para expandir/contraer detalle
        function toggleDetalles(button) {
            const fila = button.closest("tr");
            const siguiente = fila.nextElementSibling;
            if (siguiente && siguiente.classList.contains("detalle-fila")) {
                siguiente.classList.toggle("hidden");
                const icono = button.querySelector("i");
                icono.classList.toggle("bi-caret-down-fill");
                icono.classList.toggle("bi-caret-up-fill");
            }
        }

        // Controles de paginación
        document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderSolicitudes();
        }
        });
        document.getElementById("nextPage").addEventListener("click", () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderSolicitudes();
            }
        });
        document.getElementById("rowsPerPageSelect").addEventListener("change", (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderSolicitudes();
        });
        // Manejo de clicks en la tabla
        document.querySelector("#tablaSolicitudes tbody").addEventListener("click", (e) => {
            // Buscamos si el clic fue en un botón de editar
            const btnEditar = e.target.closest(".btn-editar");
            if (btnEditar) {
                const nroSolicitud = Number(btnEditar.dataset.id);
                editarSolicitud(nroSolicitud);
                return;
            }

            // Buscamos si el clic fue en un botón de toggle detalles
            const btnToggle = e.target.closest(".btn-toggle");
            if (btnToggle) {
                toggleDetalles(btnToggle);
                return;
            }
        });
        // Filtros
        document.querySelectorAll("#filterNroSolicitud, #filterUbicacion, #filterEstado, #filterFecha, #filterSolicitante")
            .forEach(input => {
                const eventType = (input.tagName === "SELECT" || input.type === "date") ? "change" : "input";
                input.addEventListener(eventType, () => {
                    currentPage = 1;
                    renderSolicitudes();
                });
        });

        cargarOpciones("ubicacionesSugeridas", "ubicaciones", false);
        cargarOpciones("categoriasSugeridas", "categorias");

        document.getElementById("solicitudForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!confirm("¿Crear esta solicitud?")) return;

            const ubicacion = document.getElementById("ubicacion").value.trim().toUpperCase();
            const solicitante = +document.getElementById("solicitante").value;
            const descripcionInput = document.getElementById("descripcion").value.trim().toUpperCase();
            const descripcion = descripcionInput === "" ? null : descripcionInput;

            if (!ubicacion || !solicitante || itemsSolicitados.length == 0) {
                alert("Datos incompletos.");
                return;
            }

            if (ubicacion === "SIN ASIGNAR") {
                alert("No puede solicitarse una entrega a SIN ASIGNAR");
                return;
            }

            const solicitud = {
                solicitante,
                ubicacionBienes: ubicacion,
                bienesPedidos: itemsSolicitados,
                ...(descripcion ? {descripcion} : {})
            }

            try {
                const response = await crearSolicitud(solicitud);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar el registro de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Solicitud registrada.");
            await recargarSolicitudes();
            await recargarUbicaciones();
            await recargarCategorias();

            cargarOpciones("ubicacionesSugeridas", "ubicaciones", false);
            cargarOpciones("categoriasSugeridas", "categorias");
            renderSolicitudes();
            itemsSolicitados = [];
            renderItemsCreate();
            e.target.reset();
        });

        function editarSolicitud(id) {
            const solicitudes = JSON.parse(localStorage.getItem("solicitudes")) || [];
            const sol = solicitudes.find(s => s.numSolicitud === id);
            if (!sol) return;

            const form = document.getElementById("modificarSolicitudForm");
            form.dataset.originalSolicitante = sol.solicitante || "";
            form.dataset.originalUbicacion = sol.ubicacionBienes.trim().toUpperCase() || "";
            form.dataset.originalEstado = sol.estado.toUpperCase() || "";
            form.dataset.originalDescripcion = sol.descripcion ? sol.descripcion.trim().toUpperCase() : "";
            modItemsSolicitados = sol.bienesPedidos ? JSON.parse(JSON.stringify(sol.bienesPedidos)) : [];
            form.dataset.originalItems = JSON.stringify(modItemsSolicitados);

            document.getElementById("modSolicitudId").value = sol.numSolicitud;
            document.getElementById("modUbicacion").value = sol.ubicacionBienes;
            document.getElementById("modEstado").value = sol.estado;
            document.getElementById("modDescripcion").value = sol.descripcion ? sol.descripcion.trim().toUpperCase() : "";
            document.getElementById("modSolicitante").value = sol.solicitante;
            renderItemsMod(); // Dibujar los items en la lista

            document.getElementById("modificarSolicitudSection").classList.remove("hidden");

            document.getElementById("modificarSolicitudSection").scrollIntoView({ behavior: "smooth" });
            document.getElementById("modUbicacion").focus({ preventScroll: true });
        }

        document.getElementById("modificarSolicitudForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!confirm("¿Modificar esta solicitud?")) return;
            const id = +document.getElementById("modSolicitudId").value;
            const form = e.target;

            // Obtener valores viejos y nuevos
            const originalUbicacion = form.dataset.originalUbicacion;
            const originalEstado = form.dataset.originalEstado;
            const originalDescripcion = form.dataset.originalDescripcion;
            const originalSolicitante = form.dataset.originalSolicitante;
            const originalItems = form.dataset.originalItems || "[]";

            const nuevaUbicacion = document.getElementById("modUbicacion").value.trim().toUpperCase();
            const nuevoEstado = document.getElementById("modEstado").value.toUpperCase();
            const nuevoSolicitante = +document.getElementById("modSolicitante").value;
            const nuevosItemsString = JSON.stringify(modItemsSolicitados);
            const nuevaDescrInput = document.getElementById("modDescripcion").value.trim().toUpperCase();
            const nuevaDescrTemp = nuevaDescrInput === "" ? null : nuevaDescrInput;
            let idsBienesAsignados;

            if (originalEstado === "APROBADA" && nuevoEstado === "SATISFECHA") {
                try {
                    // Esperamos a que el usuario termine de usar el modal
                    // modItemsSolicitados es el array global con lo que el usuario pide
                    idsBienesAsignados = await openAsignarBienesModal(modItemsSolicitados);
                    
                    // Si la promise se resuelve, continuamos.
                    // 'idsBienesAsignados' contiene los IDs, pero tu API actual no
                    // parece usarlos, así que solo continuamos.
                    console.log("Bienes seleccionados por el usuario:", idsBienesAsignados);
                    
                } catch (error) {
                    // Si la promise se rechaza (cancela, no hay stock)
                    alert("Acción cancelada. " + error);
                    return; // Detenemos el envío del formulario
                }
            }
            // --- FIN DE LA NUEVA LÓGICA DE INTERCEPCIÓN ---
            if (
                nuevaUbicacion === originalUbicacion &&
                nuevoEstado === originalEstado &&
                nuevaDescrInput === originalDescripcion &&
                nuevosItemsString === originalItems &&
                nuevoSolicitante == originalSolicitante
            ) {
                alert("No se detectaron cambios en los datos.");
                return;
            }

            if (!nuevaUbicacion || !nuevoEstado || !nuevoSolicitante || modItemsSolicitados.length == 0) {
                alert("Datos incompletos.");
                return;
            }

            if (nuevaUbicacion === "SIN ASIGNAR") {
                alert("No puede solicitarse una entrega a SIN ASIGNAR");
                return;
            }

            const solicitudModificada = {
                solicitante: nuevoSolicitante,
                ubicacionBienes: nuevaUbicacion,
                ...(nuevaDescrTemp ? { descripcion: nuevaDescrTemp } : {}),
                estado: nuevoEstado,
                bienesPedidos: modItemsSolicitados,
                ...(idsBienesAsignados ? {nroInventarioDeBienesAEntregar: idsBienesAsignados} : {})
            }

            try {
                const response = await modificarSolicitud(solicitudModificada, id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 404) {
                        alert("Solicitud no encontrada.");
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la modificación de la solicitud. Código: 500");
                        return;
                    } else {
                        alert(`El servidor no pudo realizar la modificación de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }

            alert("Solicitud actualizada.");
            await recargarSolicitudes();
            await recargarUbicaciones();
            await recargarCategorias();

            cargarOpciones("ubicacionesSugeridas", "ubicaciones", false);
            cargarOpciones("categoriasSugeridas", "categorias");
            renderSolicitudes();
            document.getElementById("modificarSolicitudSection").classList.add("hidden");
            modItemsSolicitados = [];
            renderItemsCreate(); // Aquí había un error, debería ser renderItemsMod() o resetear. Uso reset.
            e.target.reset();

            document.getElementById("tablaSolicitudes").parentElement.scrollIntoView({ behavior: "smooth" });
        });

        document.getElementById("eliminarSolicitudBtn").addEventListener("click", async () => {
            const id = +document.getElementById("modSolicitudId").value;
            if (!confirm("¿Eliminar esta solicitud?")) return;

            try {
                const response = await eliminarSolicitud(id);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status == 422) {
                        alert(errorData.error);
                        return;
                    }
                    if (response.status == 500) {
                        alert("El servidor no pudo realizar la eliminación de la solicitud. Código: 500");
                        return;
                    }
                    else {
                        alert(`El servidor no pudo realizar la eliminación de la solicitud. Código: ${response.status}`);
                        return;
                    }
                }
            } catch (error) {
                alert("No se pudo conectar con el servidor.");
                return;
            }
            alert("Solicitud eliminada.");
            await recargarSolicitudes();
            renderSolicitudes();
            document.getElementById("modificarSolicitudSection").classList.add("hidden");
            document.getElementById("modificarSolicitudForm").reset();

            document.getElementById("tablaSolicitudes").parentElement.scrollIntoView({ behavior: "smooth" });
        });

        // Cancelar edición de datos
        document.getElementById("cancelarBtn").onclick = () => {
            if (confirm("¿Deseás cancelar la edición? Se perderán los cambios no guardados.")) {
                document.getElementById("modificarSolicitudSection").classList.add("hidden");
                document.getElementById("modificarSolicitudForm").reset();

                modItemsSolicitados = []; // Limpiar array
                renderItemsMod();       // Limpiar lista visual

                document.getElementById("tablaSolicitudes").parentElement.scrollIntoView({ behavior: "smooth" });
            }
        };

        renderSolicitudes();
    </script>
</body>

</html>